<!DOCTYPE html>
<html>
<meta  lang="zh-CN" >
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="theme-color" content="#fff" id="theme-color">
  <link rel="icon" href="/img/Kaze.png">
  <title>Numbfish的个人博客</title>
  <script>
    // control reverse button
    var reverseDarkList = {
      dark: 'light',
      light: 'dark'
    };
    var themeColor = {
      dark: '#1c1c1e',
      light: '#fff'
    }
    // get the data of css prefers-color-scheme
    var getCssMediaQuery = function() {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };
    // reverse current darkmode setting function
    var reverseDarkModeSetting = function() {
      var setting = localStorage.getItem('user-color-scheme');
      if(reverseDarkList[setting]) {
        setting = reverseDarkList[setting];
      } else if(setting === null) {
        setting = reverseDarkList[getCssMediaQuery()];
      } else {
        return;
      }
      localStorage.setItem('user-color-scheme', setting);
      return setting;
    };
    // apply current darkmode setting
    var setDarkmode = function(mode) {
      var setting = mode || localStorage.getItem('user-color-scheme');
      if(setting === getCssMediaQuery()) {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[setting];
      } else if(reverseDarkList[setting]) {
        document.documentElement.setAttribute('data-user-color-scheme', setting);
        document.getElementById('theme-color').content = themeColor[setting];
      } else {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[getCssMediaQuery()];
      }
    };
    setDarkmode();
  </script>
  <script>
    function loadScript(url, cb) {
      var script = document.createElement('script');
      script.src = url;
      if (cb) script.onload = cb;
      script.async = true;
      document.body.appendChild(script);
    }
  </script>
  
  <link rel="preload" href="//at.alicdn.com/t/font_1946621_vpj3dq9ceqa.css" as="style" >
  <link rel="preload" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css" as="style" >
  
  <link rel="preload" href="//cdn.jsdelivr.net/npm/fslightbox@3.1.0/index.min.js" as="script">
  
  
  <link rel="preload" href="/js/lib/lozad.min.js" as="script">
  
  
  
  
  
  <link rel="prefetch" href="//cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" as="script">
  
  
  
  
  
<link rel="stylesheet" href="/css/main.css">

  
  
<link rel="stylesheet" href="//at.alicdn.com/t/font_1946621_vpj3dq9ceqa.css">

  
  
<link rel="stylesheet" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css">

  
  
  
  
  
  <link href="/js/lib/prism/prism-tomorrow.min.css" rel="stylesheet" data-prism="prism-tomorrow">
  
  
  
<link rel="stylesheet" href="/js/lib/prism/prism-line-numbers.min.css">

  
  
  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  <div class="wrapper">
    
    <nav class="navbar">
  <div class="navbar-logo">
    <span class="navbar-logo-main">
      
      <img class="navbar-logo-img" src="/img/Kaze.png">
      
      <span class="navbar-logo-dsc">Numbfish的个人博客</span>
    </span>
  </div>
  <div class="navbar-menu">
    
    <a href="/" class="navbar-menu-item">首页 </a>
    
    <a href="/archives" class="navbar-menu-item">归档 </a>
    
    <a href="/tags" class="navbar-menu-item">标签 </a>
    
    <a href="/categories" class="navbar-menu-item">分类 </a>
    
    <a href="/about" class="navbar-menu-item">关于 </a>
    
    <a href="/links" class="navbar-menu-item">友链 </a>
    
    <a class="navbar-menu-item darknavbar" id="dark"><i class="iconfont icon-weather"></i></a>
  </div>
</nav>
    
    <div class="section-wrap">
      <div class="container">
        <div class="columns">
          <main class="main-column">
<div class="image-wrapper">
  <img src="/img/ray-marching-002.jpg" data-src="/img/ray-marching-002.jpg"
    srcset="/img/ray-marching-002.jpg"
    class="image lozad">
</div>

<article class="card card-content">
  <header>
    <h1 class="post-title">
      二渲三技术，光线步进Ray Marching
    </h1>
  </header>
  <div class="post-meta post-show-meta">
    <time datetime="2024-08-07T02:00:00.000Z" style="display: flex; align-items: center;">
      <i class="iconfont icon-calendar" style="margin-right: 2px;"></i>
      <span>2024-08-07</span>
    </time>
    
    <span class="dot"></span>
    
    <a href="/categories/Shader/" class="post-meta-link">Shader</a>
    
    
    
    <span class="dot"></span>
    <span>6.7k 字</span>
    
  </div>
  
  </header>
  <div id="section" class="post-content">
    <h1 id="ray-marching"><a class="markdownIt-Anchor" href="#ray-marching"></a> Ray Marching</h1>
<h2 id="一-简介"><a class="markdownIt-Anchor" href="#一-简介"></a> 一、简介</h2>
<p>光线步进，使用shader代码建模，主要的学习资料：<a target="_blank" rel="noopener" href="https://jamie-wong.com/2016/07/15/ray-marching-signed-distance-functions/">Ray Marching and Signed Distance Functions (jamie-wong.com)</a></p>
<p>如果要应用在Unity中，一般可以用来实现体积云，可参考：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1964y157fA/">https://www.bilibili.com/video/BV1964y157fA/</a></p>
<p>另外可以在建模软件中得到模型的SDF，来实现特定形状的体积云，效果可参考：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1LK421i76u/">https://www.bilibili.com/video/BV1LK421i76u/</a></p>
<h2 id="二-signed-distance-functionssdf有符号距离函数"><a class="markdownIt-Anchor" href="#二-signed-distance-functionssdf有符号距离函数"></a> 二、Signed Distance Functions（SDF，有符号距离函数）</h2>
<p>构建一个半径为1的球：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mo stretchy="false">)</mo><mo>=</mo><msqrt><mrow><msup><mi>x</mi><mn>2</mn></msup><mo>+</mo><msup><mi>y</mi><mn>2</mn></msup><mo>+</mo><msup><mi>z</mi><mn>2</mn></msup></mrow></msqrt><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">f(x,y,z)=\sqrt{x^2+y^2+z^2}-1
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.24em;vertical-align:-0.23329099999999992em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.006709em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"></span><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-2.9667090000000003em;"><span class="pstrut" style="height:3.2em;"></span><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg width='400em' height='1.28em' viewBox='0 0 400000 1296' preserveAspectRatio='xMinYMin slice'><path d='M263,681c0.7,0,18,39.7,52,119
c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120
c340,-704.7,510.7,-1060.3,512,-1067
l0 -0
c4.7,-7.3,11,-11,19,-11
H40000v40H1012.3
s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232
c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1
s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26
c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z
M1001 80h400000v40h-400000z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.23329099999999992em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span></span></p>
<p>代入几个点试试：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo><mo>=</mo><mn>0</mn><mspace linebreak="newline"></mspace><mi>f</mi><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo separator="true">,</mo><mn>0.5</mn><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><mn>0.5</mn><mspace linebreak="newline"></mspace><mi>f</mi><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mn>3</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">f(1,0,0)=0\\
f(0,0,0.5)=-0.5\\
f(0,3,0)=2
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span></span></p>
<p>第一个点在球面上，第二个点在球内，第三个点在球外</p>
<p>改成代码形式：</p>
<pre class="line-numbers language-b" data-language="b"><code class="language-b">float SphereSdf(vec3 p) &#123;
    return length(p) - 1.0;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>其他几何形体的SDF可以参考此网站：<a target="_blank" rel="noopener" href="https://iquilezles.org/articles/distfunctions/">Inigo Quilez :: computer graphics, mathematics, shaders, fractals, demoscene and more (iquilezles.org)</a></p>
<h2 id="三-ray-marching光线步进"><a class="markdownIt-Anchor" href="#三-ray-marching光线步进"></a> 三、Ray Marching（光线步进）</h2>
<p>在Ray Tracing（光线追踪）中，通常定义一个场景里包含有多种几何形体，然后从相机发出视射线（View Ray），根据射线与物体相交情况，计算获取屏幕像素颜色值。光线追踪的原理可以看这个网站：<a target="_blank" rel="noopener" href="https://www.scratchapixel.com/lessons/3d-basic-rendering/introduction-to-ray-tracing/how-does-it-work.html">3D Computer Graphics Primer: Ray-Tracing as an Example (scratchapixel.com)</a></p>
<p><img src="/img/ray-marching-001.png" alt="" / srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/img/ray-marching-001.png" class="lozad post-image"></p>
<p>在Ray Marching中，则定义了多个SDF，为了获取射线相交情况，从相机开始发出视射线，逐步前进取点。在逐步前进时不断发出询问：”现在的点是否在场景物体内了？“，相当于：”当前点SDF是否是负数了？“。如果是负数了或者达到最大前进距离了，则结束前进</p>
<p>我们可以每次前进一个很小的距离来完成Ray Marching，但是更好的做法是使用Sphere Tracing（球追踪）来完成，可以每次移动更大的安全距离，减少计算量。球追踪算法图示如下</p>
<p><img src="/img/ray-marching-002.jpg" alt="" / srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/img/ray-marching-002.jpg" class="lozad post-image"></p>
<p>代码形式：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">float</span> depth <span class="token operator">=</span> start<span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_MARCHING_STEPS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">float</span> dist <span class="token operator">=</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span>eye <span class="token operator">+</span> depth <span class="token operator">*</span> viewRayDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dist <span class="token operator">&lt;</span> EPSILON<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// We're inside the scene surface!</span>
        <span class="token keyword">return</span> depth<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// Move along the view ray</span>
    depth <span class="token operator">+=</span> dist<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>depth <span class="token operator">>=</span> end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Gone too far; give up</span>
        <span class="token keyword">return</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">return</span> end<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>现在用这些理论绘制一个纯红的球：<a target="_blank" rel="noopener" href="https://www.shadertoy.com/view/llt3R4">Ray Marching: Part 1 (shadertoy.com)</a></p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">const</span> <span class="token keyword">int</span> MAX_MARCHING_STEPS <span class="token operator">=</span> <span class="token number">255</span><span class="token punctuation">;</span> <span class="token comment">// 最大步进次数</span>
<span class="token keyword">const</span> <span class="token keyword">float</span> MIN_DIST <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span> <span class="token comment">// 最小距离</span>
<span class="token keyword">const</span> <span class="token keyword">float</span> MAX_DIST <span class="token operator">=</span> <span class="token number">100.0</span><span class="token punctuation">;</span> <span class="token comment">// 最大距离</span>
<span class="token keyword">const</span> <span class="token keyword">float</span> EPSILON <span class="token operator">=</span> <span class="token number">0.0001</span><span class="token punctuation">;</span> <span class="token comment">// 小于此值则可以结束当前步进</span>

<span class="token comment">// 半径1的球体SDF</span>
<span class="token keyword">float</span> <span class="token function">sphereSDF</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> samplePoint<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">length</span><span class="token punctuation">(</span>samplePoint<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 场景SDF</span>
<span class="token keyword">float</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> samplePoint<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">sphereSDF</span><span class="token punctuation">(</span>samplePoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 离平面最小距离计算</span>
<span class="token keyword">float</span> <span class="token function">shortestDistanceToSurface</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> eye<span class="token punctuation">,</span> <span class="token keyword">vec3</span> marchingDirection<span class="token punctuation">,</span> <span class="token keyword">float</span> start<span class="token punctuation">,</span> <span class="token keyword">float</span> end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">float</span> depth <span class="token operator">=</span> start<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_MARCHING_STEPS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">float</span> dist <span class="token operator">=</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span>eye <span class="token operator">+</span> depth <span class="token operator">*</span> marchingDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dist <span class="token operator">&lt;</span> EPSILON<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> depth<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        depth <span class="token operator">+=</span> dist<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>depth <span class="token operator">>=</span> end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> end<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> end<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
            
<span class="token comment">// 根据当前片元fragCoord, 计算射线方向</span>
<span class="token keyword">vec3</span> <span class="token function">rayDirection</span><span class="token punctuation">(</span><span class="token keyword">float</span> fieldOfView<span class="token punctuation">,</span> <span class="token keyword">vec2</span> size<span class="token punctuation">,</span> <span class="token keyword">vec2</span> fragCoord<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">vec2</span> xy <span class="token operator">=</span> fragCoord <span class="token operator">-</span> size <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> z <span class="token operator">=</span> size<span class="token punctuation">.</span>y <span class="token operator">/</span> <span class="token function">tan</span><span class="token punctuation">(</span><span class="token function">radians</span><span class="token punctuation">(</span>fieldOfView<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>xy<span class="token punctuation">,</span> <span class="token operator">-</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// main</span>
<span class="token keyword">void</span> <span class="token function">mainImage</span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token keyword">vec4</span> fragColor<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> fragCoord<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">vec3</span> dir <span class="token operator">=</span> <span class="token function">rayDirection</span><span class="token punctuation">(</span><span class="token number">45.0</span><span class="token punctuation">,</span> iResolution<span class="token punctuation">.</span>xy<span class="token punctuation">,</span> fragCoord<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 射线方向, fov 45</span>
    <span class="token keyword">vec3</span> eye <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 相机坐标</span>
    <span class="token keyword">float</span> dist <span class="token operator">=</span> <span class="token function">shortestDistanceToSurface</span><span class="token punctuation">(</span>eye<span class="token punctuation">,</span> dir<span class="token punctuation">,</span> MIN_DIST<span class="token punctuation">,</span> MAX_DIST<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dist <span class="token operator">></span> MAX_DIST <span class="token operator">-</span> EPSILON<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Didn't hit anything</span>
        fragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    fragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/img/ray-marching-003.png.png" alt="" / srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/img/ray-marching-003.png.png" class="lozad post-image"></p>
<p>Unity版本，先提供基本框架：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl">Shader <span class="token string">"RayMarching"</span> <span class="token punctuation">&#123;</span>
    Properties <span class="token punctuation">&#123;</span>
        <span class="token function">_MainTex</span><span class="token punctuation">(</span><span class="token string">"Texture"</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    SubShader <span class="token punctuation">&#123;</span>
        Tags <span class="token punctuation">&#123;</span>
            <span class="token string">"Queue"</span> <span class="token operator">=</span> <span class="token string">"Transparent"</span>
            <span class="token string">"RenderType"</span> <span class="token operator">=</span> <span class="token string">"Transparent"</span>
        <span class="token punctuation">&#125;</span>
        Lighting Off
        ZWrite Off
        Blend SrcAlpha OneMinusSrcAlpha

        Pass <span class="token punctuation">&#123;</span>
            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UnityCG.cginc"</span></span>

            <span class="token keyword">struct</span> <span class="token class-name">appdata</span> <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float2 uv <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">v2f</span> <span class="token punctuation">&#123;</span>
                float2 uv <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
                float4 vertex <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">sampler2D</span> _MainTex<span class="token punctuation">;</span>
            float4 _MainTex_ST<span class="token punctuation">;</span>

            v2f <span class="token function">vert</span><span class="token punctuation">(</span>appdata v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>vertex <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>uv <span class="token operator">=</span> <span class="token function">TRANSFORM_TEX</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>uv<span class="token punctuation">,</span> _MainTex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">UNITY_TRANSFER_FOG</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span>o<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            fixed4 <span class="token function">frag</span> <span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            ENDCG
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后补上Ray Marching算法：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl">Shader <span class="token string">"RayMarching"</span> <span class="token punctuation">&#123;</span>
    Properties <span class="token punctuation">&#123;</span>
        <span class="token function">_MainTex</span><span class="token punctuation">(</span><span class="token string">"Texture"</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    SubShader <span class="token punctuation">&#123;</span>
        Tags <span class="token punctuation">&#123;</span>
            <span class="token string">"Queue"</span> <span class="token operator">=</span> <span class="token string">"Transparent"</span>
            <span class="token string">"RenderType"</span> <span class="token operator">=</span> <span class="token string">"Transparent"</span>
        <span class="token punctuation">&#125;</span>
        Lighting Off
        ZWrite Off
        Blend SrcAlpha OneMinusSrcAlpha

        Pass <span class="token punctuation">&#123;</span>
            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UnityCG.cginc"</span></span>

            <span class="token keyword">struct</span> <span class="token class-name">appdata</span> <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float2 uv <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">v2f</span> <span class="token punctuation">&#123;</span>
                float2 uv <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
                float4 vertex <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">sampler2D</span> _MainTex<span class="token punctuation">;</span>
            float4 _MainTex_ST<span class="token punctuation">;</span>

            v2f <span class="token function">vert</span><span class="token punctuation">(</span>appdata v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>vertex <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>uv <span class="token operator">=</span> <span class="token function">TRANSFORM_TEX</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>uv<span class="token punctuation">,</span> _MainTex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">UNITY_TRANSFER_FOG</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span>o<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_MARCHING_STEPS</span> <span class="token expression"><span class="token number">255</span></span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MIN_DIST</span> <span class="token expression"><span class="token number">0</span></span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_DIST</span> <span class="token expression"><span class="token number">100</span></span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EPSILON</span> <span class="token expression"><span class="token number">0.0001</span></span></span>

            <span class="token keyword">float</span> <span class="token function">sphereSDF</span><span class="token punctuation">(</span>float3 samplePoint<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token function">length</span><span class="token punctuation">(</span>samplePoint<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">float</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span>float3 samplePoint<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token function">sphereSDF</span><span class="token punctuation">(</span>samplePoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">float</span> <span class="token function">shortestDistanceToSurface</span><span class="token punctuation">(</span>float3 eye<span class="token punctuation">,</span> float3 marchingDirection<span class="token punctuation">,</span> <span class="token keyword">float</span> start<span class="token punctuation">,</span> <span class="token keyword">float</span> end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">float</span> depth <span class="token operator">=</span> start<span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_MARCHING_STEPS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">float</span> dist <span class="token operator">=</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span>eye <span class="token operator">+</span> depth <span class="token operator">*</span> marchingDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>dist <span class="token operator">&lt;</span> EPSILON<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">return</span> depth<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                    depth <span class="token operator">+=</span> dist<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>depth <span class="token operator">>=</span> end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">return</span> end<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">return</span> end<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            float3 <span class="token function">rayDirection</span><span class="token punctuation">(</span><span class="token keyword">float</span> fieldOfView<span class="token punctuation">,</span> float2 size<span class="token punctuation">,</span> float2 fragCoord<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                float2 xy <span class="token operator">=</span> fragCoord <span class="token operator">-</span> size <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> z <span class="token operator">=</span> size<span class="token punctuation">.</span>y <span class="token operator">/</span> <span class="token function">tan</span><span class="token punctuation">(</span><span class="token function">radians</span><span class="token punctuation">(</span>fieldOfView<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>xy<span class="token punctuation">,</span> <span class="token operator">-</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            fixed4 <span class="token function">frag</span> <span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target <span class="token punctuation">&#123;</span>
                float3 dir <span class="token operator">=</span> <span class="token function">rayDirection</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 参数size用1x1就行</span>
                float3 eye <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> dist <span class="token operator">=</span> <span class="token function">shortestDistanceToSurface</span><span class="token punctuation">(</span>eye<span class="token punctuation">,</span> dir<span class="token punctuation">,</span> MIN_DIST<span class="token punctuation">,</span> MAX_DIST<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>dist <span class="token operator">></span> MAX_DIST <span class="token operator">-</span> EPSILON<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">return</span> <span class="token function">fixed4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            ENDCG
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建材质，拖到平面物体上，得到的效果：</p>
<p><img src="/img/ray-marching-004.png" alt="" / srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/img/ray-marching-004.png" class="lozad post-image"></p>
<h2 id="四-平面法线与光照"><a class="markdownIt-Anchor" href="#四-平面法线与光照"></a> 四、平面法线与光照</h2>
<p>法线相当于计算SDF的梯度，公式：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">∇</mi><mi>f</mi><mo>=</mo><mo stretchy="false">(</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>f</mi></mrow><mrow><mi mathvariant="normal">∂</mi><mi>x</mi></mrow></mfrac><mo separator="true">,</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>f</mi></mrow><mrow><mi mathvariant="normal">∂</mi><mi>y</mi></mrow></mfrac><mo separator="true">,</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>f</mi></mrow><mrow><mi mathvariant="normal">∂</mi><mi>z</mi></mrow></mfrac><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\nabla f=(\frac{\partial f}{\partial x},\frac{\partial f}{\partial y},\frac{\partial f}{\partial z})
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord">∇</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.25188em;vertical-align:-0.8804400000000001em;"></span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714399999999998em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">x</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714399999999998em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8804400000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714399999999998em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>但是不需要一定用微积分来获得精确结果，可以使用这样的形式获取法线：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mi>n</mi><mo>⃗</mo></mover><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo>+</mo><mi>ϵ</mi><mo separator="true">,</mo><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mo stretchy="false">)</mo><mo>−</mo><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo>−</mo><mi>ϵ</mi><mo separator="true">,</mo><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo>+</mo><mi>ϵ</mi><mo separator="true">,</mo><mi>z</mi><mo stretchy="false">)</mo><mo>−</mo><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo>−</mo><mi>ϵ</mi><mo separator="true">,</mo><mi>z</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mo>+</mo><mi>ϵ</mi><mo stretchy="false">)</mo><mo>−</mo><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mo>−</mo><mi>ϵ</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\vec{n}=\begin{bmatrix}
f(x+\epsilon,y,z)-f(x-\epsilon,y,z)\\
f(x,y+\epsilon,z)-f(x,y-\epsilon,z)\\
f(x,y,z+\epsilon)-f(x,y,z-\epsilon)
\end{bmatrix}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.714em;vertical-align:0em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2355em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg width='0.471em' height='0.714em' style='width:0.471em' viewBox='0 0 471 714' preserveAspectRatio='xMinYMin'><path d='M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5
3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11
10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63
-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1
-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59
H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359
c-16-25.333-24-45-24-59z'/></svg></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.6010299999999997em;vertical-align:-1.55002em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">ϵ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">ϵ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">ϵ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">ϵ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">ϵ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathnormal">ϵ</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>对应的代码为：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">vec3</span> <span class="token function">estimateNormal</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>
        <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x <span class="token operator">+</span> EPSILON<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x <span class="token operator">-</span> EPSILON<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y <span class="token operator">+</span> EPSILON<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y <span class="token operator">-</span> EPSILON<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z <span class="token operator">+</span> EPSILON<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z <span class="token operator">-</span> EPSILON<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>有了法线计算公式后可以应用上Phong光照模型，完整代码：<a target="_blank" rel="noopener" href="https://www.shadertoy.com/view/lt33z7">Ray Marching: Part 2 (shadertoy.com)</a></p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">const</span> <span class="token keyword">int</span> MAX_MARCHING_STEPS <span class="token operator">=</span> <span class="token number">255</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">float</span> MIN_DIST <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">float</span> MAX_DIST <span class="token operator">=</span> <span class="token number">100.0</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">float</span> EPSILON <span class="token operator">=</span> <span class="token number">0.0001</span><span class="token punctuation">;</span>

<span class="token keyword">float</span> <span class="token function">sphereSDF</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> samplePoint<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">length</span><span class="token punctuation">(</span>samplePoint<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">float</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> samplePoint<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">sphereSDF</span><span class="token punctuation">(</span>samplePoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">float</span> <span class="token function">shortestDistanceToSurface</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> eye<span class="token punctuation">,</span> <span class="token keyword">vec3</span> marchingDirection<span class="token punctuation">,</span> <span class="token keyword">float</span> start<span class="token punctuation">,</span> <span class="token keyword">float</span> end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">float</span> depth <span class="token operator">=</span> start<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_MARCHING_STEPS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">float</span> dist <span class="token operator">=</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span>eye <span class="token operator">+</span> depth <span class="token operator">*</span> marchingDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dist <span class="token operator">&lt;</span> EPSILON<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> depth<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        depth <span class="token operator">+=</span> dist<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>depth <span class="token operator">>=</span> end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> end<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> end<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">vec3</span> <span class="token function">rayDirection</span><span class="token punctuation">(</span><span class="token keyword">float</span> fieldOfView<span class="token punctuation">,</span> <span class="token keyword">vec2</span> size<span class="token punctuation">,</span> <span class="token keyword">vec2</span> fragCoord<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">vec2</span> xy <span class="token operator">=</span> fragCoord <span class="token operator">-</span> size <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> z <span class="token operator">=</span> size<span class="token punctuation">.</span>y <span class="token operator">/</span> <span class="token function">tan</span><span class="token punctuation">(</span><span class="token function">radians</span><span class="token punctuation">(</span>fieldOfView<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>xy<span class="token punctuation">,</span> <span class="token operator">-</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">vec3</span> <span class="token function">estimateNormal</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>
        <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x <span class="token operator">+</span> EPSILON<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x <span class="token operator">-</span> EPSILON<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y <span class="token operator">+</span> EPSILON<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y <span class="token operator">-</span> EPSILON<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z <span class="token operator">+</span> EPSILON<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z <span class="token operator">-</span> EPSILON<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// Phong光照模型</span>
<span class="token comment">/**
 * Lighting contribution of a single point light source via Phong illumination.
 * 
 * The vec3 returned is the RGB color of the light's contribution.
 *
 * k_a: Ambient color
 * k_d: Diffuse color
 * k_s: Specular color
 * alpha: Shininess coefficient
 * p: position of point being lit
 * eye: the position of the camera
 * lightPos: the position of the light
 * lightIntensity: color/intensity of the light
 *
 * See https://en.wikipedia.org/wiki/Phong_reflection_model#Description
 */</span>
<span class="token keyword">vec3</span> <span class="token function">phongContribForLight</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> k_d<span class="token punctuation">,</span> <span class="token keyword">vec3</span> k_s<span class="token punctuation">,</span> <span class="token keyword">float</span> alpha<span class="token punctuation">,</span> <span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">vec3</span> eye<span class="token punctuation">,</span> <span class="token keyword">vec3</span> lightPos<span class="token punctuation">,</span> <span class="token keyword">vec3</span> lightIntensity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">vec3</span> N <span class="token operator">=</span> <span class="token function">estimateNormal</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> L <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>lightPos <span class="token operator">-</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> V <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>eye <span class="token operator">-</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> R <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">reflect</span><span class="token punctuation">(</span><span class="token operator">-</span>L<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">float</span> dotLN <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> dotRV <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>R<span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dotLN <span class="token operator">&lt;</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Light not visible from this point on the surface</span>
        <span class="token keyword">return</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> 
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dotRV <span class="token operator">&lt;</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Light reflection in opposite direction as viewer, apply only diffuse</span>
        <span class="token comment">// component</span>
        <span class="token keyword">return</span> lightIntensity <span class="token operator">*</span> <span class="token punctuation">(</span>k_d <span class="token operator">*</span> dotLN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> lightIntensity <span class="token operator">*</span> <span class="token punctuation">(</span>k_d <span class="token operator">*</span> dotLN <span class="token operator">+</span> k_s <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span>dotRV<span class="token punctuation">,</span> alpha<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 添加多个光照</span>
<span class="token comment">/**
 * Lighting via Phong illumination.
 * 
 * The vec3 returned is the RGB color of that point after lighting is applied.
 * k_a: Ambient color
 * k_d: Diffuse color
 * k_s: Specular color
 * alpha: Shininess coefficient
 * p: position of point being lit
 * eye: the position of the camera
 *
 * See https://en.wikipedia.org/wiki/Phong_reflection_model#Description
 */</span>
<span class="token keyword">vec3</span> <span class="token function">phongIllumination</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> k_a<span class="token punctuation">,</span> <span class="token keyword">vec3</span> k_d<span class="token punctuation">,</span> <span class="token keyword">vec3</span> k_s<span class="token punctuation">,</span> <span class="token keyword">float</span> alpha<span class="token punctuation">,</span> <span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">vec3</span> eye<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token keyword">vec3</span> ambientLight <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> color <span class="token operator">=</span> ambientLight <span class="token operator">*</span> k_a<span class="token punctuation">;</span>
    
    <span class="token keyword">vec3</span> light1Pos <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">4.0</span> <span class="token operator">*</span> <span class="token function">sin</span><span class="token punctuation">(</span>iTime<span class="token punctuation">)</span><span class="token punctuation">,</span>
                          <span class="token number">2.0</span><span class="token punctuation">,</span>
                          <span class="token number">4.0</span> <span class="token operator">*</span> <span class="token function">cos</span><span class="token punctuation">(</span>iTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> light1Intensity <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    color <span class="token operator">+=</span> <span class="token function">phongContribForLight</span><span class="token punctuation">(</span>k_d<span class="token punctuation">,</span> k_s<span class="token punctuation">,</span> alpha<span class="token punctuation">,</span> p<span class="token punctuation">,</span> eye<span class="token punctuation">,</span>
                                  light1Pos<span class="token punctuation">,</span>
                                  light1Intensity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">vec3</span> light2Pos <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">2.0</span> <span class="token operator">*</span> <span class="token function">sin</span><span class="token punctuation">(</span><span class="token number">0.37</span> <span class="token operator">*</span> iTime<span class="token punctuation">)</span><span class="token punctuation">,</span>
                          <span class="token number">2.0</span> <span class="token operator">*</span> <span class="token function">cos</span><span class="token punctuation">(</span><span class="token number">0.37</span> <span class="token operator">*</span> iTime<span class="token punctuation">)</span><span class="token punctuation">,</span>
                          <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> light2Intensity <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    color <span class="token operator">+=</span> <span class="token function">phongContribForLight</span><span class="token punctuation">(</span>k_d<span class="token punctuation">,</span> k_s<span class="token punctuation">,</span> alpha<span class="token punctuation">,</span> p<span class="token punctuation">,</span> eye<span class="token punctuation">,</span>
                                  light2Pos<span class="token punctuation">,</span>
                                  light2Intensity<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token keyword">return</span> color<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">mainImage</span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token keyword">vec4</span> fragColor<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> fragCoord<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">vec3</span> dir <span class="token operator">=</span> <span class="token function">rayDirection</span><span class="token punctuation">(</span><span class="token number">45.0</span><span class="token punctuation">,</span> iResolution<span class="token punctuation">.</span>xy<span class="token punctuation">,</span> fragCoord<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> eye <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> dist <span class="token operator">=</span> <span class="token function">shortestDistanceToSurface</span><span class="token punctuation">(</span>eye<span class="token punctuation">,</span> dir<span class="token punctuation">,</span> MIN_DIST<span class="token punctuation">,</span> MAX_DIST<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dist <span class="token operator">></span> MAX_DIST <span class="token operator">-</span> EPSILON<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Didn't hit anything</span>
        fragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// The closest point on the surface to the eyepoint along the view ray</span>
    <span class="token keyword">vec3</span> p <span class="token operator">=</span> eye <span class="token operator">+</span> dist <span class="token operator">*</span> dir<span class="token punctuation">;</span>
    
    <span class="token keyword">vec3</span> K_a <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> K_d <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> K_s <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> shininess <span class="token operator">=</span> <span class="token number">10.0</span><span class="token punctuation">;</span>
    
    <span class="token keyword">vec3</span> color <span class="token operator">=</span> <span class="token function">phongIllumination</span><span class="token punctuation">(</span>K_a<span class="token punctuation">,</span> K_d<span class="token punctuation">,</span> K_s<span class="token punctuation">,</span> shininess<span class="token punctuation">,</span> p<span class="token punctuation">,</span> eye<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    fragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>color<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/img/ray-marching-005.png" alt="" / srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/img/ray-marching-005.png" class="lozad post-image"></p>
<p>同样的提供一个Unity版本：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl">Shader <span class="token string">"RayMarching"</span> <span class="token punctuation">&#123;</span>
    Properties <span class="token punctuation">&#123;</span>
        <span class="token function">_MainTex</span><span class="token punctuation">(</span><span class="token string">"Texture"</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    SubShader <span class="token punctuation">&#123;</span>
        Tags <span class="token punctuation">&#123;</span>
            <span class="token string">"Queue"</span> <span class="token operator">=</span> <span class="token string">"Transparent"</span>
            <span class="token string">"RenderType"</span> <span class="token operator">=</span> <span class="token string">"Transparent"</span>
        <span class="token punctuation">&#125;</span>
        Lighting Off
        ZWrite Off
        Blend SrcAlpha OneMinusSrcAlpha

        Pass <span class="token punctuation">&#123;</span>
            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UnityCG.cginc"</span></span>

            <span class="token keyword">struct</span> <span class="token class-name">appdata</span> <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float2 uv <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">v2f</span> <span class="token punctuation">&#123;</span>
                float2 uv <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
                float4 vertex <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">sampler2D</span> _MainTex<span class="token punctuation">;</span>
            float4 _MainTex_ST<span class="token punctuation">;</span>

            v2f <span class="token function">vert</span><span class="token punctuation">(</span>appdata v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>vertex <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>uv <span class="token operator">=</span> <span class="token function">TRANSFORM_TEX</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>uv<span class="token punctuation">,</span> _MainTex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">UNITY_TRANSFER_FOG</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span>o<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_MARCHING_STEPS</span> <span class="token expression"><span class="token number">255</span></span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MIN_DIST</span> <span class="token expression"><span class="token number">0</span></span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_DIST</span> <span class="token expression"><span class="token number">100</span></span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EPSILON</span> <span class="token expression"><span class="token number">0.0001</span></span></span>

            <span class="token keyword">float</span> <span class="token function">sphereSDF</span><span class="token punctuation">(</span>float3 samplePoint<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token function">length</span><span class="token punctuation">(</span>samplePoint<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">float</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span>float3 samplePoint<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token function">sphereSDF</span><span class="token punctuation">(</span>samplePoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">float</span> <span class="token function">shortestDistanceToSurface</span><span class="token punctuation">(</span>float3 eye<span class="token punctuation">,</span> float3 marchingDirection<span class="token punctuation">,</span> <span class="token keyword">float</span> start<span class="token punctuation">,</span> <span class="token keyword">float</span> end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">float</span> depth <span class="token operator">=</span> start<span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_MARCHING_STEPS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">float</span> dist <span class="token operator">=</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span>eye <span class="token operator">+</span> depth <span class="token operator">*</span> marchingDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>dist <span class="token operator">&lt;</span> EPSILON<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">return</span> depth<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                    depth <span class="token operator">+=</span> dist<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>depth <span class="token operator">>=</span> end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">return</span> end<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">return</span> end<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            float3 <span class="token function">rayDirection</span><span class="token punctuation">(</span><span class="token keyword">float</span> fieldOfView<span class="token punctuation">,</span> float2 size<span class="token punctuation">,</span> float2 fragCoord<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                float2 xy <span class="token operator">=</span> fragCoord <span class="token operator">-</span> size <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> z <span class="token operator">=</span> size<span class="token punctuation">.</span>y <span class="token operator">/</span> <span class="token function">tan</span><span class="token punctuation">(</span><span class="token function">radians</span><span class="token punctuation">(</span>fieldOfView<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>xy<span class="token punctuation">,</span> <span class="token operator">-</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            float3 <span class="token function">estimateNormal</span><span class="token punctuation">(</span>float3 p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>
                    <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x <span class="token operator">+</span> EPSILON<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x <span class="token operator">-</span> EPSILON<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y <span class="token operator">+</span> EPSILON<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y <span class="token operator">-</span> EPSILON<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z <span class="token operator">+</span> EPSILON<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z <span class="token operator">-</span> EPSILON<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            float3 <span class="token function">phongContribForLight</span><span class="token punctuation">(</span>float3 k_d<span class="token punctuation">,</span> float3 k_s<span class="token punctuation">,</span> <span class="token keyword">float</span> alpha<span class="token punctuation">,</span> float3 p<span class="token punctuation">,</span> float3 eye<span class="token punctuation">,</span> float3 lightPos<span class="token punctuation">,</span> float3 lightIntensity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                float3 N <span class="token operator">=</span> <span class="token function">estimateNormal</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 L <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>lightPos <span class="token operator">-</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 V <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>eye <span class="token operator">-</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 R <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">reflect</span><span class="token punctuation">(</span><span class="token operator">-</span>L<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">float</span> dotLN <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> dotRV <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>R<span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>dotLN <span class="token operator">&lt;</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// Light not visible from this point on the surface</span>
                    <span class="token keyword">return</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> 

                <span class="token keyword">if</span> <span class="token punctuation">(</span>dotRV <span class="token operator">&lt;</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// Light reflection in opposite direction as viewer, apply only diffuse</span>
                    <span class="token comment">// component</span>
                    <span class="token keyword">return</span> lightIntensity <span class="token operator">*</span> <span class="token punctuation">(</span>k_d <span class="token operator">*</span> dotLN<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">return</span> lightIntensity <span class="token operator">*</span> <span class="token punctuation">(</span>k_d <span class="token operator">*</span> dotLN <span class="token operator">+</span> k_s <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span>dotRV<span class="token punctuation">,</span> alpha<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            float3 <span class="token function">phongIllumination</span><span class="token punctuation">(</span>float3 k_a<span class="token punctuation">,</span> float3 k_d<span class="token punctuation">,</span> float3 k_s<span class="token punctuation">,</span> <span class="token keyword">float</span> alpha<span class="token punctuation">,</span> float3 p<span class="token punctuation">,</span> float3 eye<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">float</span> iTime <span class="token operator">=</span> _Time<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
                <span class="token keyword">const</span> float3 ambientLight <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 color <span class="token operator">=</span> ambientLight <span class="token operator">*</span> k_a<span class="token punctuation">;</span>
                float3 light1Pos <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">4.0</span> <span class="token operator">*</span> <span class="token function">sin</span><span class="token punctuation">(</span>iTime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">4.0</span> <span class="token operator">*</span> <span class="token function">cos</span><span class="token punctuation">(</span>iTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 light1Intensity <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                color <span class="token operator">+=</span> <span class="token function">phongContribForLight</span><span class="token punctuation">(</span>k_d<span class="token punctuation">,</span> k_s<span class="token punctuation">,</span> alpha<span class="token punctuation">,</span> p<span class="token punctuation">,</span> eye<span class="token punctuation">,</span> light1Pos<span class="token punctuation">,</span> light1Intensity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 light2Pos <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">2.0</span> <span class="token operator">*</span> <span class="token function">sin</span><span class="token punctuation">(</span><span class="token number">0.37</span> <span class="token operator">*</span> iTime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2.0</span> <span class="token operator">*</span> <span class="token function">cos</span><span class="token punctuation">(</span><span class="token number">0.37</span> <span class="token operator">*</span> iTime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 light2Intensity <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                color <span class="token operator">+=</span> <span class="token function">phongContribForLight</span><span class="token punctuation">(</span>k_d<span class="token punctuation">,</span> k_s<span class="token punctuation">,</span> alpha<span class="token punctuation">,</span> p<span class="token punctuation">,</span> eye<span class="token punctuation">,</span> light2Pos<span class="token punctuation">,</span> light2Intensity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> color<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            fixed4 <span class="token function">frag</span> <span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target <span class="token punctuation">&#123;</span>
                float3 dir <span class="token operator">=</span> <span class="token function">rayDirection</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 eye <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> dist <span class="token operator">=</span> <span class="token function">shortestDistanceToSurface</span><span class="token punctuation">(</span>eye<span class="token punctuation">,</span> dir<span class="token punctuation">,</span> MIN_DIST<span class="token punctuation">,</span> MAX_DIST<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>dist <span class="token operator">></span> MAX_DIST <span class="token operator">-</span> EPSILON<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

                <span class="token comment">// The closest point on the surface to the eyepoint along the view ray</span>
                float3 p <span class="token operator">=</span> eye <span class="token operator">+</span> dist <span class="token operator">*</span> dir<span class="token punctuation">;</span>
                float3 K_a <span class="token operator">=</span> <span class="token number">0.03</span><span class="token punctuation">;</span>
                float3 K_d <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 K_s <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> shininess <span class="token operator">=</span> <span class="token number">10.0</span><span class="token punctuation">;</span>
                float3 color <span class="token operator">=</span> <span class="token function">phongIllumination</span><span class="token punctuation">(</span>K_a<span class="token punctuation">,</span> K_d<span class="token punctuation">,</span> K_s<span class="token punctuation">,</span> shininess<span class="token punctuation">,</span> p<span class="token punctuation">,</span> eye<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">fixed4</span><span class="token punctuation">(</span>color<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            ENDCG
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/img/ray-marching-006.png" alt="" / srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/img/ray-marching-006.png" class="lozad post-image"></p>
<h2 id="五-相机移动"><a class="markdownIt-Anchor" href="#五-相机移动"></a> 五、相机移动</h2>
<p>可以以OpenGL中的gluLookAt函数为参考，来写自己的相机矩阵来控制相机移动：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token comment">/**
 * Return a transformation matrix that will transform a ray from view space
 * to world coordinates, given the eye point, the camera target, and an up vector.
 *
 * This assumes that the center of the camera is aligned with the negative z axis in
 * view space when calculating the ray marching direction.
 */</span>
<span class="token keyword">mat4</span> <span class="token function">viewMatrix</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> eye<span class="token punctuation">,</span> <span class="token keyword">vec3</span> center<span class="token punctuation">,</span> <span class="token keyword">vec3</span> up<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">vec3</span> f <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>center <span class="token operator">-</span> eye<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">vec3</span> s <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">cross</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> up<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">vec3</span> u <span class="token operator">=</span> <span class="token function">cross</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token keyword">mat4</span><span class="token punctuation">(</span>
		<span class="token keyword">vec4</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token keyword">vec4</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token operator">-</span>f<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>示例，让相机在(8, 5, 7)这个坐标正面看着一个矩形：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">const</span> <span class="token keyword">int</span> MAX_MARCHING_STEPS <span class="token operator">=</span> <span class="token number">255</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">float</span> MIN_DIST <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">float</span> MAX_DIST <span class="token operator">=</span> <span class="token number">100.0</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">float</span> EPSILON <span class="token operator">=</span> <span class="token number">0.0001</span><span class="token punctuation">;</span>

<span class="token keyword">float</span> <span class="token function">cubeSDF</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">vec3</span> d <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> insideDistance <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>y<span class="token punctuation">,</span> d<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> outsideDistance <span class="token operator">=</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> insideDistance <span class="token operator">+</span> outsideDistance<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">float</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> samplePoint<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">cubeSDF</span><span class="token punctuation">(</span>samplePoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">float</span> <span class="token function">shortestDistanceToSurface</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> eye<span class="token punctuation">,</span> <span class="token keyword">vec3</span> marchingDirection<span class="token punctuation">,</span> <span class="token keyword">float</span> start<span class="token punctuation">,</span> <span class="token keyword">float</span> end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">float</span> depth <span class="token operator">=</span> start<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_MARCHING_STEPS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">float</span> dist <span class="token operator">=</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span>eye <span class="token operator">+</span> depth <span class="token operator">*</span> marchingDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dist <span class="token operator">&lt;</span> EPSILON<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">return</span> depth<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        depth <span class="token operator">+=</span> dist<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>depth <span class="token operator">>=</span> end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> end<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> end<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
            
<span class="token keyword">vec3</span> <span class="token function">rayDirection</span><span class="token punctuation">(</span><span class="token keyword">float</span> fieldOfView<span class="token punctuation">,</span> <span class="token keyword">vec2</span> size<span class="token punctuation">,</span> <span class="token keyword">vec2</span> fragCoord<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">vec2</span> xy <span class="token operator">=</span> fragCoord <span class="token operator">-</span> size <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> z <span class="token operator">=</span> size<span class="token punctuation">.</span>y <span class="token operator">/</span> <span class="token function">tan</span><span class="token punctuation">(</span><span class="token function">radians</span><span class="token punctuation">(</span>fieldOfView<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>xy<span class="token punctuation">,</span> <span class="token operator">-</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">vec3</span> <span class="token function">estimateNormal</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>
        <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x <span class="token operator">+</span> EPSILON<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x <span class="token operator">-</span> EPSILON<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y <span class="token operator">+</span> EPSILON<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y <span class="token operator">-</span> EPSILON<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z  <span class="token operator">+</span> EPSILON<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token keyword">vec3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z <span class="token operator">-</span> EPSILON<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">vec3</span> <span class="token function">phongContribForLight</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> k_d<span class="token punctuation">,</span> <span class="token keyword">vec3</span> k_s<span class="token punctuation">,</span> <span class="token keyword">float</span> alpha<span class="token punctuation">,</span> <span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">vec3</span> eye<span class="token punctuation">,</span> <span class="token keyword">vec3</span> lightPos<span class="token punctuation">,</span> <span class="token keyword">vec3</span> lightIntensity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">vec3</span> N <span class="token operator">=</span> <span class="token function">estimateNormal</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> L <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>lightPos <span class="token operator">-</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> V <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>eye <span class="token operator">-</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> R <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">reflect</span><span class="token punctuation">(</span><span class="token operator">-</span>L<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">float</span> dotLN <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> dotRV <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>R<span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dotLN <span class="token operator">&lt;</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Light not visible from this point on the surface</span>
        <span class="token keyword">return</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> 
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dotRV <span class="token operator">&lt;</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Light reflection in opposite direction as viewer, apply only diffuse</span>
        <span class="token comment">// component</span>
        <span class="token keyword">return</span> lightIntensity <span class="token operator">*</span> <span class="token punctuation">(</span>k_d <span class="token operator">*</span> dotLN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> lightIntensity <span class="token operator">*</span> <span class="token punctuation">(</span>k_d <span class="token operator">*</span> dotLN <span class="token operator">+</span> k_s <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span>dotRV<span class="token punctuation">,</span> alpha<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">vec3</span> <span class="token function">phongIllumination</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> k_a<span class="token punctuation">,</span> <span class="token keyword">vec3</span> k_d<span class="token punctuation">,</span> <span class="token keyword">vec3</span> k_s<span class="token punctuation">,</span> <span class="token keyword">float</span> alpha<span class="token punctuation">,</span> <span class="token keyword">vec3</span> p<span class="token punctuation">,</span> <span class="token keyword">vec3</span> eye<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token keyword">vec3</span> ambientLight <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> color <span class="token operator">=</span> ambientLight <span class="token operator">*</span> k_a<span class="token punctuation">;</span>
    
    <span class="token keyword">vec3</span> light1Pos <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">4.0</span> <span class="token operator">*</span> <span class="token function">sin</span><span class="token punctuation">(</span>iTime<span class="token punctuation">)</span><span class="token punctuation">,</span>
                          <span class="token number">2.0</span><span class="token punctuation">,</span>
                          <span class="token number">4.0</span> <span class="token operator">*</span> <span class="token function">cos</span><span class="token punctuation">(</span>iTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> light1Intensity <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    color <span class="token operator">+=</span> <span class="token function">phongContribForLight</span><span class="token punctuation">(</span>k_d<span class="token punctuation">,</span> k_s<span class="token punctuation">,</span> alpha<span class="token punctuation">,</span> p<span class="token punctuation">,</span> eye<span class="token punctuation">,</span>
                                  light1Pos<span class="token punctuation">,</span>
                                  light1Intensity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">vec3</span> light2Pos <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">2.0</span> <span class="token operator">*</span> <span class="token function">sin</span><span class="token punctuation">(</span><span class="token number">0.37</span> <span class="token operator">*</span> iTime<span class="token punctuation">)</span><span class="token punctuation">,</span>
                          <span class="token number">2.0</span> <span class="token operator">*</span> <span class="token function">cos</span><span class="token punctuation">(</span><span class="token number">0.37</span> <span class="token operator">*</span> iTime<span class="token punctuation">)</span><span class="token punctuation">,</span>
                          <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> light2Intensity <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    color <span class="token operator">+=</span> <span class="token function">phongContribForLight</span><span class="token punctuation">(</span>k_d<span class="token punctuation">,</span> k_s<span class="token punctuation">,</span> alpha<span class="token punctuation">,</span> p<span class="token punctuation">,</span> eye<span class="token punctuation">,</span>
                                  light2Pos<span class="token punctuation">,</span>
                                  light2Intensity<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token keyword">return</span> color<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">mat4</span> <span class="token function">viewMatrix</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> eye<span class="token punctuation">,</span> <span class="token keyword">vec3</span> center<span class="token punctuation">,</span> <span class="token keyword">vec3</span> up<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Based on gluLookAt man page</span>
    <span class="token keyword">vec3</span> f <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>center <span class="token operator">-</span> eye<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> s <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">cross</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> up<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> u <span class="token operator">=</span> <span class="token function">cross</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">mat4</span><span class="token punctuation">(</span>
        <span class="token keyword">vec4</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">vec4</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token operator">-</span>f<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">mainImage</span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token keyword">vec4</span> fragColor<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">vec2</span> fragCoord<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">vec3</span> viewDir <span class="token operator">=</span> <span class="token function">rayDirection</span><span class="token punctuation">(</span><span class="token number">45.0</span><span class="token punctuation">,</span> iResolution<span class="token punctuation">.</span>xy<span class="token punctuation">,</span> fragCoord<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> eye <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">8.0</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">,</span> <span class="token number">7.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">mat4</span> viewToWorld <span class="token operator">=</span> <span class="token function">viewMatrix</span><span class="token punctuation">(</span>eye<span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> worldDir <span class="token operator">=</span> <span class="token punctuation">(</span>viewToWorld <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>viewDir<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
    <span class="token keyword">float</span> dist <span class="token operator">=</span> <span class="token function">shortestDistanceToSurface</span><span class="token punctuation">(</span>eye<span class="token punctuation">,</span> worldDir<span class="token punctuation">,</span> MIN_DIST<span class="token punctuation">,</span> MAX_DIST<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dist <span class="token operator">></span> MAX_DIST <span class="token operator">-</span> EPSILON<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Didn't hit anything</span>
        fragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// The closest point on the surface to the eyepoint along the view ray</span>
    <span class="token keyword">vec3</span> p <span class="token operator">=</span> eye <span class="token operator">+</span> dist <span class="token operator">*</span> worldDir<span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> K_a <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> K_d <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> K_s <span class="token operator">=</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> shininess <span class="token operator">=</span> <span class="token number">10.0</span><span class="token punctuation">;</span>
    <span class="token keyword">vec3</span> color <span class="token operator">=</span> <span class="token function">phongIllumination</span><span class="token punctuation">(</span>K_a<span class="token punctuation">,</span> K_d<span class="token punctuation">,</span> K_s<span class="token punctuation">,</span> shininess<span class="token punctuation">,</span> p<span class="token punctuation">,</span> eye<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fragColor <span class="token operator">=</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>color<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/img/ray-marching-007.png" alt="" / srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/img/ray-marching-007.png" class="lozad post-image"></p>
<p>Unity版本：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl">Shader <span class="token string">"RayMarching"</span> <span class="token punctuation">&#123;</span>
    Properties <span class="token punctuation">&#123;</span>
        <span class="token function">_MainTex</span><span class="token punctuation">(</span><span class="token string">"Texture"</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    SubShader <span class="token punctuation">&#123;</span>
        Tags <span class="token punctuation">&#123;</span>
            <span class="token string">"Queue"</span> <span class="token operator">=</span> <span class="token string">"Transparent"</span>
            <span class="token string">"RenderType"</span> <span class="token operator">=</span> <span class="token string">"Transparent"</span>
        <span class="token punctuation">&#125;</span>
        Lighting Off
        ZWrite Off
        Blend SrcAlpha OneMinusSrcAlpha

        Pass <span class="token punctuation">&#123;</span>
            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UnityCG.cginc"</span></span>

            <span class="token keyword">struct</span> <span class="token class-name">appdata</span> <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float2 uv <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">v2f</span> <span class="token punctuation">&#123;</span>
                float2 uv <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
                float4 vertex <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">sampler2D</span> _MainTex<span class="token punctuation">;</span>
            float4 _MainTex_ST<span class="token punctuation">;</span>

            v2f <span class="token function">vert</span><span class="token punctuation">(</span>appdata v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>vertex <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>uv <span class="token operator">=</span> <span class="token function">TRANSFORM_TEX</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>uv<span class="token punctuation">,</span> _MainTex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">UNITY_TRANSFER_FOG</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span>o<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_MARCHING_STEPS</span> <span class="token expression"><span class="token number">255</span></span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MIN_DIST</span> <span class="token expression"><span class="token number">0</span></span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_DIST</span> <span class="token expression"><span class="token number">100</span></span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EPSILON</span> <span class="token expression"><span class="token number">0.0001</span></span></span>

            <span class="token keyword">float</span> <span class="token function">cubeSDF</span><span class="token punctuation">(</span>float3 p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                float3 d <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> insideDistance <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>y<span class="token punctuation">,</span> d<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> outsideDistance <span class="token operator">=</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> insideDistance <span class="token operator">+</span> outsideDistance<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">float</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span>float3 samplePoint<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token function">cubeSDF</span><span class="token punctuation">(</span>samplePoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">float</span> <span class="token function">shortestDistanceToSurface</span><span class="token punctuation">(</span>float3 eye<span class="token punctuation">,</span> float3 marchingDirection<span class="token punctuation">,</span> <span class="token keyword">float</span> start<span class="token punctuation">,</span> <span class="token keyword">float</span> end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">float</span> depth <span class="token operator">=</span> start<span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_MARCHING_STEPS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">float</span> dist <span class="token operator">=</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span>eye <span class="token operator">+</span> depth <span class="token operator">*</span> marchingDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>dist <span class="token operator">&lt;</span> EPSILON<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">return</span> depth<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                    depth <span class="token operator">+=</span> dist<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>depth <span class="token operator">>=</span> end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">return</span> end<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">return</span> end<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            float3 <span class="token function">rayDirection</span><span class="token punctuation">(</span><span class="token keyword">float</span> fieldOfView<span class="token punctuation">,</span> float2 size<span class="token punctuation">,</span> float2 fragCoord<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                float2 xy <span class="token operator">=</span> fragCoord <span class="token operator">-</span> size <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> z <span class="token operator">=</span> size<span class="token punctuation">.</span>y <span class="token operator">/</span> <span class="token function">tan</span><span class="token punctuation">(</span><span class="token function">radians</span><span class="token punctuation">(</span>fieldOfView<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>xy<span class="token punctuation">,</span> <span class="token operator">-</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            float3 <span class="token function">estimateNormal</span><span class="token punctuation">(</span>float3 p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>
                    <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x <span class="token operator">+</span> EPSILON<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x <span class="token operator">-</span> EPSILON<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y <span class="token operator">+</span> EPSILON<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y <span class="token operator">-</span> EPSILON<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z <span class="token operator">+</span> EPSILON<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z <span class="token operator">-</span> EPSILON<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            float3 <span class="token function">phongContribForLight</span><span class="token punctuation">(</span>float3 k_d<span class="token punctuation">,</span> float3 k_s<span class="token punctuation">,</span> <span class="token keyword">float</span> alpha<span class="token punctuation">,</span> float3 p<span class="token punctuation">,</span> float3 eye<span class="token punctuation">,</span> float3 lightPos<span class="token punctuation">,</span> float3 lightIntensity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                float3 N <span class="token operator">=</span> <span class="token function">estimateNormal</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 L <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>lightPos <span class="token operator">-</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 V <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>eye <span class="token operator">-</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 R <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">reflect</span><span class="token punctuation">(</span><span class="token operator">-</span>L<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">float</span> dotLN <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> dotRV <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>R<span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>dotLN <span class="token operator">&lt;</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// Light not visible from this point on the surface</span>
                    <span class="token keyword">return</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> 

                <span class="token keyword">if</span> <span class="token punctuation">(</span>dotRV <span class="token operator">&lt;</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// Light reflection in opposite direction as viewer, apply only diffuse</span>
                    <span class="token comment">// component</span>
                    <span class="token keyword">return</span> lightIntensity <span class="token operator">*</span> <span class="token punctuation">(</span>k_d <span class="token operator">*</span> dotLN<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">return</span> lightIntensity <span class="token operator">*</span> <span class="token punctuation">(</span>k_d <span class="token operator">*</span> dotLN <span class="token operator">+</span> k_s <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span>dotRV<span class="token punctuation">,</span> alpha<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            float3 <span class="token function">phongIllumination</span><span class="token punctuation">(</span>float3 k_a<span class="token punctuation">,</span> float3 k_d<span class="token punctuation">,</span> float3 k_s<span class="token punctuation">,</span> <span class="token keyword">float</span> alpha<span class="token punctuation">,</span> float3 p<span class="token punctuation">,</span> float3 eye<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">float</span> iTime <span class="token operator">=</span> _Time<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
                <span class="token keyword">const</span> float3 ambientLight <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 color <span class="token operator">=</span> ambientLight <span class="token operator">*</span> k_a<span class="token punctuation">;</span>
                float3 light1Pos <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">4.0</span> <span class="token operator">*</span> <span class="token function">sin</span><span class="token punctuation">(</span>iTime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">4.0</span> <span class="token operator">*</span> <span class="token function">cos</span><span class="token punctuation">(</span>iTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 light1Intensity <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                color <span class="token operator">+=</span> <span class="token function">phongContribForLight</span><span class="token punctuation">(</span>k_d<span class="token punctuation">,</span> k_s<span class="token punctuation">,</span> alpha<span class="token punctuation">,</span> p<span class="token punctuation">,</span> eye<span class="token punctuation">,</span> light1Pos<span class="token punctuation">,</span> light1Intensity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 light2Pos <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">2.0</span> <span class="token operator">*</span> <span class="token function">sin</span><span class="token punctuation">(</span><span class="token number">0.37</span> <span class="token operator">*</span> iTime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2.0</span> <span class="token operator">*</span> <span class="token function">cos</span><span class="token punctuation">(</span><span class="token number">0.37</span> <span class="token operator">*</span> iTime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 light2Intensity <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                color <span class="token operator">+=</span> <span class="token function">phongContribForLight</span><span class="token punctuation">(</span>k_d<span class="token punctuation">,</span> k_s<span class="token punctuation">,</span> alpha<span class="token punctuation">,</span> p<span class="token punctuation">,</span> eye<span class="token punctuation">,</span> light2Pos<span class="token punctuation">,</span> light2Intensity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> color<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            float4x4 <span class="token function">viewMatrix</span><span class="token punctuation">(</span>float3 eye<span class="token punctuation">,</span> float3 center<span class="token punctuation">,</span> float3 up<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// Based on gluLookAt man page</span>
                float3 f <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>center <span class="token operator">-</span> eye<span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 s <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">cross</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> up<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 u <span class="token operator">=</span> <span class="token function">cross</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">float4x4</span><span class="token punctuation">(</span>
                    <span class="token function">float4</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">float4</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">float4</span><span class="token punctuation">(</span><span class="token operator">-</span>f<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">float4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            fixed4 <span class="token function">frag</span> <span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target <span class="token punctuation">&#123;</span>
                float3 viewDir <span class="token operator">=</span> <span class="token function">rayDirection</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 eye <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                float4x4 viewToWorld <span class="token operator">=</span> <span class="token function">viewMatrix</span><span class="token punctuation">(</span>eye<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 worldDir <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span><span class="token function">float4</span><span class="token punctuation">(</span>viewDir<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> viewToWorld<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span> <span class="token comment">// 这里需要反过来使用mul计算</span>
                <span class="token keyword">float</span> dist <span class="token operator">=</span> <span class="token function">shortestDistanceToSurface</span><span class="token punctuation">(</span>eye<span class="token punctuation">,</span> worldDir<span class="token punctuation">,</span> MIN_DIST<span class="token punctuation">,</span> MAX_DIST<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>dist <span class="token operator">></span> MAX_DIST <span class="token operator">-</span> EPSILON<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// Didn't hit anything</span>
                    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token comment">// The closest point on the surface to the eyepoint along the view ray</span>
                float3 p <span class="token operator">=</span> eye <span class="token operator">+</span> dist <span class="token operator">*</span> worldDir<span class="token punctuation">;</span>
                float3 K_a <span class="token operator">=</span> <span class="token number">0.03</span><span class="token punctuation">;</span>
                float3 K_d <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 K_s <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> shininess <span class="token operator">=</span> <span class="token number">10.0</span><span class="token punctuation">;</span>
                float3 color <span class="token operator">=</span> <span class="token function">phongIllumination</span><span class="token punctuation">(</span>K_a<span class="token punctuation">,</span> K_d<span class="token punctuation">,</span> K_s<span class="token punctuation">,</span> shininess<span class="token punctuation">,</span> p<span class="token punctuation">,</span> eye<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">fixed4</span><span class="token punctuation">(</span>color<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            ENDCG
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/img/ray-marching-008.png" alt="" / srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/img/ray-marching-008.png" class="lozad post-image"></p>
<h2 id="六-构建几何体"><a class="markdownIt-Anchor" href="#六-构建几何体"></a> 六、构建几何体</h2>
<p><img src="/img/ray-marching-009.png" alt="" / srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/img/ray-marching-009.png" class="lozad post-image"></p>
<p>需要使用三种基础运算符：</p>
<ul>
<li>∩：intersection，相交</li>
<li>∪：union，组合</li>
<li>−：difference，差异</li>
</ul>
<p>对应的代码为：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">float</span> <span class="token function">intersectSDF</span><span class="token punctuation">(</span><span class="token keyword">float</span> distA<span class="token punctuation">,</span> <span class="token keyword">float</span> distB<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">max</span><span class="token punctuation">(</span>distA<span class="token punctuation">,</span> distB<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">float</span> <span class="token function">unionSDF</span><span class="token punctuation">(</span><span class="token keyword">float</span> distA<span class="token punctuation">,</span> <span class="token keyword">float</span> distB<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">min</span><span class="token punctuation">(</span>distA<span class="token punctuation">,</span> distB<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">float</span> <span class="token function">differenceSDF</span><span class="token punctuation">(</span><span class="token keyword">float</span> distA<span class="token punctuation">,</span> <span class="token keyword">float</span> distB<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">max</span><span class="token punctuation">(</span>distA<span class="token punctuation">,</span> <span class="token operator">-</span>distB<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中负的SDF相当于内外翻转的几何体，所以函数differenceSDF做的就是A几何体和内外翻转的B几何体相交的结果</p>
<p>另外还有别的其他构建几何体的运算，可以参考此网站的Primitive combinations部分：<a target="_blank" rel="noopener" href="https://iquilezles.org/articles/distfunctions/">Inigo Quilez :: computer graphics, mathematics, shaders, fractals, demoscene and more (iquilezles.org)</a></p>
<p>Unity构建上图的结果：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl">Shader <span class="token string">"RayMarching"</span> <span class="token punctuation">&#123;</span>
    Properties <span class="token punctuation">&#123;</span>
        <span class="token function">_MainTex</span><span class="token punctuation">(</span><span class="token string">"Texture"</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    SubShader <span class="token punctuation">&#123;</span>
        Tags <span class="token punctuation">&#123;</span>
            <span class="token string">"Queue"</span> <span class="token operator">=</span> <span class="token string">"Transparent"</span>
            <span class="token string">"RenderType"</span> <span class="token operator">=</span> <span class="token string">"Transparent"</span>
        <span class="token punctuation">&#125;</span>
        Lighting Off
        ZWrite Off
        Blend SrcAlpha OneMinusSrcAlpha

        Pass <span class="token punctuation">&#123;</span>
            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UnityCG.cginc"</span></span>

            <span class="token keyword">struct</span> <span class="token class-name">appdata</span> <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float2 uv <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">v2f</span> <span class="token punctuation">&#123;</span>
                float2 uv <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
                float4 vertex <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">sampler2D</span> _MainTex<span class="token punctuation">;</span>
            float4 _MainTex_ST<span class="token punctuation">;</span>

            v2f <span class="token function">vert</span><span class="token punctuation">(</span>appdata v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>vertex <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>uv <span class="token operator">=</span> <span class="token function">TRANSFORM_TEX</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>uv<span class="token punctuation">,</span> _MainTex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">UNITY_TRANSFER_FOG</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span>o<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_MARCHING_STEPS</span> <span class="token expression"><span class="token number">255</span></span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MIN_DIST</span> <span class="token expression"><span class="token number">0</span></span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_DIST</span> <span class="token expression"><span class="token number">100</span></span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EPSILON</span> <span class="token expression"><span class="token number">0.0001</span></span></span>

            <span class="token keyword">float</span> <span class="token function">sphereSDF</span><span class="token punctuation">(</span>float3 p<span class="token punctuation">,</span> <span class="token keyword">float</span> r<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token function">length</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">-</span> r<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">float</span> <span class="token function">cubeSDF</span><span class="token punctuation">(</span>float3 p<span class="token punctuation">,</span> <span class="token keyword">float</span> w<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                float3 d <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">-</span> w<span class="token punctuation">;</span>
                <span class="token keyword">float</span> insideDistance <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>y<span class="token punctuation">,</span> d<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> outsideDistance <span class="token operator">=</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> insideDistance <span class="token operator">+</span> outsideDistance<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">float</span> <span class="token function">cylinderSDF</span><span class="token punctuation">(</span>float3 p<span class="token punctuation">,</span> <span class="token keyword">float</span> h<span class="token punctuation">,</span> <span class="token keyword">float</span> r<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              float2 d <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">float2</span><span class="token punctuation">(</span><span class="token function">length</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>xz<span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">float2</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>x<span class="token punctuation">,</span> d<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">float</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span>float3 p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">float</span> cube <span class="token operator">=</span> <span class="token function">cubeSDF</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> sphere <span class="token operator">=</span> <span class="token function">sphereSDF</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token number">1.3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> cylinderA <span class="token operator">=</span> <span class="token function">cylinderSDF</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 圆柱体稍微长一些, 需要挖穿几何体</span>
                <span class="token keyword">float</span> cylinderB <span class="token operator">=</span> <span class="token function">cylinderSDF</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> cylinderC <span class="token operator">=</span> <span class="token function">cylinderSDF</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>cube<span class="token punctuation">,</span> sphere<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token function">min</span><span class="token punctuation">(</span>cylinderA<span class="token punctuation">,</span> cylinderB<span class="token punctuation">)</span><span class="token punctuation">,</span> cylinderC<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">float</span> <span class="token function">shortestDistanceToSurface</span><span class="token punctuation">(</span>float3 eye<span class="token punctuation">,</span> float3 marchingDirection<span class="token punctuation">,</span> <span class="token keyword">float</span> start<span class="token punctuation">,</span> <span class="token keyword">float</span> end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">float</span> depth <span class="token operator">=</span> start<span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_MARCHING_STEPS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">float</span> dist <span class="token operator">=</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span>eye <span class="token operator">+</span> depth <span class="token operator">*</span> marchingDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>dist <span class="token operator">&lt;</span> EPSILON<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">return</span> depth<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                    depth <span class="token operator">+=</span> dist<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>depth <span class="token operator">>=</span> end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">return</span> end<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">return</span> end<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            float3 <span class="token function">rayDirection</span><span class="token punctuation">(</span><span class="token keyword">float</span> fieldOfView<span class="token punctuation">,</span> float2 size<span class="token punctuation">,</span> float2 fragCoord<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                float2 xy <span class="token operator">=</span> fragCoord <span class="token operator">-</span> size <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> z <span class="token operator">=</span> size<span class="token punctuation">.</span>y <span class="token operator">/</span> <span class="token function">tan</span><span class="token punctuation">(</span><span class="token function">radians</span><span class="token punctuation">(</span>fieldOfView<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>xy<span class="token punctuation">,</span> <span class="token operator">-</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            float3 <span class="token function">estimateNormal</span><span class="token punctuation">(</span>float3 p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>
                    <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x <span class="token operator">+</span> EPSILON<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x <span class="token operator">-</span> EPSILON<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y <span class="token operator">+</span> EPSILON<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y <span class="token operator">-</span> EPSILON<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z <span class="token operator">+</span> EPSILON<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z <span class="token operator">-</span> EPSILON<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            float3 <span class="token function">phongContribForLight</span><span class="token punctuation">(</span>float3 k_d<span class="token punctuation">,</span> float3 k_s<span class="token punctuation">,</span> <span class="token keyword">float</span> alpha<span class="token punctuation">,</span> float3 p<span class="token punctuation">,</span> float3 eye<span class="token punctuation">,</span> float3 lightPos<span class="token punctuation">,</span> float3 lightIntensity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                float3 N <span class="token operator">=</span> <span class="token function">estimateNormal</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 L <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>lightPos <span class="token operator">-</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 V <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>eye <span class="token operator">-</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 R <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">reflect</span><span class="token punctuation">(</span><span class="token operator">-</span>L<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">float</span> dotLN <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> dotRV <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>R<span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>dotLN <span class="token operator">&lt;</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// Light not visible from this point on the surface</span>
                    <span class="token keyword">return</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> 

                <span class="token keyword">if</span> <span class="token punctuation">(</span>dotRV <span class="token operator">&lt;</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// Light reflection in opposite direction as viewer, apply only diffuse</span>
                    <span class="token comment">// component</span>
                    <span class="token keyword">return</span> lightIntensity <span class="token operator">*</span> <span class="token punctuation">(</span>k_d <span class="token operator">*</span> dotLN<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">return</span> lightIntensity <span class="token operator">*</span> <span class="token punctuation">(</span>k_d <span class="token operator">*</span> dotLN <span class="token operator">+</span> k_s <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span>dotRV<span class="token punctuation">,</span> alpha<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            float3 <span class="token function">phongIllumination</span><span class="token punctuation">(</span>float3 k_a<span class="token punctuation">,</span> float3 k_d<span class="token punctuation">,</span> float3 k_s<span class="token punctuation">,</span> <span class="token keyword">float</span> alpha<span class="token punctuation">,</span> float3 p<span class="token punctuation">,</span> float3 eye<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">float</span> iTime <span class="token operator">=</span> _Time<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
                <span class="token keyword">const</span> float3 ambientLight <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 color <span class="token operator">=</span> ambientLight <span class="token operator">*</span> k_a<span class="token punctuation">;</span>
                float3 light1Pos <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">4.0</span> <span class="token operator">*</span> <span class="token function">sin</span><span class="token punctuation">(</span>iTime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">4.0</span> <span class="token operator">*</span> <span class="token function">cos</span><span class="token punctuation">(</span>iTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 light1Intensity <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                color <span class="token operator">+=</span> <span class="token function">phongContribForLight</span><span class="token punctuation">(</span>k_d<span class="token punctuation">,</span> k_s<span class="token punctuation">,</span> alpha<span class="token punctuation">,</span> p<span class="token punctuation">,</span> eye<span class="token punctuation">,</span> light1Pos<span class="token punctuation">,</span> light1Intensity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 light2Pos <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">2.0</span> <span class="token operator">*</span> <span class="token function">sin</span><span class="token punctuation">(</span><span class="token number">0.37</span> <span class="token operator">*</span> iTime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2.0</span> <span class="token operator">*</span> <span class="token function">cos</span><span class="token punctuation">(</span><span class="token number">0.37</span> <span class="token operator">*</span> iTime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 light2Intensity <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                color <span class="token operator">+=</span> <span class="token function">phongContribForLight</span><span class="token punctuation">(</span>k_d<span class="token punctuation">,</span> k_s<span class="token punctuation">,</span> alpha<span class="token punctuation">,</span> p<span class="token punctuation">,</span> eye<span class="token punctuation">,</span> light2Pos<span class="token punctuation">,</span> light2Intensity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> color<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            float4x4 <span class="token function">viewMatrix</span><span class="token punctuation">(</span>float3 eye<span class="token punctuation">,</span> float3 center<span class="token punctuation">,</span> float3 up<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// Based on gluLookAt man page</span>
                float3 f <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>center <span class="token operator">-</span> eye<span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 s <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">cross</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> up<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 u <span class="token operator">=</span> <span class="token function">cross</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">float4x4</span><span class="token punctuation">(</span>
                    <span class="token function">float4</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">float4</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">float4</span><span class="token punctuation">(</span><span class="token operator">-</span>f<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">float4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            fixed4 <span class="token function">frag</span> <span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target <span class="token punctuation">&#123;</span>
                float3 viewDir <span class="token operator">=</span> <span class="token function">rayDirection</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 eye <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                float4x4 viewToWorld <span class="token operator">=</span> <span class="token function">viewMatrix</span><span class="token punctuation">(</span>eye<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 worldDir <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span><span class="token function">float4</span><span class="token punctuation">(</span>viewDir<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> viewToWorld<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span> <span class="token comment">// 这里需要反过来使用mul计算</span>
                <span class="token keyword">float</span> dist <span class="token operator">=</span> <span class="token function">shortestDistanceToSurface</span><span class="token punctuation">(</span>eye<span class="token punctuation">,</span> worldDir<span class="token punctuation">,</span> MIN_DIST<span class="token punctuation">,</span> MAX_DIST<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>dist <span class="token operator">></span> MAX_DIST <span class="token operator">-</span> EPSILON<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// Didn't hit anything</span>
                    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token comment">// The closest point on the surface to the eyepoint along the view ray</span>
                float3 p <span class="token operator">=</span> eye <span class="token operator">+</span> dist <span class="token operator">*</span> worldDir<span class="token punctuation">;</span>
                float3 K_a <span class="token operator">=</span> <span class="token number">0.03</span><span class="token punctuation">;</span>
                float3 K_d <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 K_s <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> shininess <span class="token operator">=</span> <span class="token number">10.0</span><span class="token punctuation">;</span>
                float3 color <span class="token operator">=</span> <span class="token function">phongIllumination</span><span class="token punctuation">(</span>K_a<span class="token punctuation">,</span> K_d<span class="token punctuation">,</span> K_s<span class="token punctuation">,</span> shininess<span class="token punctuation">,</span> p<span class="token punctuation">,</span> eye<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">fixed4</span><span class="token punctuation">(</span>color<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            ENDCG
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/img/ray-marching-010.png" alt="" / srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/img/ray-marching-010.png" class="lozad post-image"></p>
<h2 id="七-模型变换"><a class="markdownIt-Anchor" href="#七-模型变换"></a> 七、模型变换</h2>
<h3 id="71-位移和旋转"><a class="markdownIt-Anchor" href="#71-位移和旋转"></a> 7.1 位移和旋转</h3>
<p>位移只需要控制采样点偏移就行：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">float</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> samplePoint<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">float</span> sphereDist <span class="token operator">=</span> <span class="token function">sphereSDF</span><span class="token punctuation">(</span>samplePoint <span class="token operator">/</span> <span class="token number">1.2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.2</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> cubeDist <span class="token operator">=</span> <span class="token function">cubeSDF</span><span class="token punctuation">(</span>samplePoint <span class="token operator">+</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token function">sin</span><span class="token punctuation">(</span>iGlobalTime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">intersectSDF</span><span class="token punctuation">(</span>cubeDist<span class="token punctuation">,</span> sphereDist<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>旋转则使用旋转矩阵乘上采样点的方式：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">mat4</span> <span class="token function">rotateY</span><span class="token punctuation">(</span><span class="token keyword">float</span> theta<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">float</span> c <span class="token operator">=</span> <span class="token function">cos</span><span class="token punctuation">(</span>theta<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> s <span class="token operator">=</span> <span class="token function">sin</span><span class="token punctuation">(</span>theta<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">mat4</span><span class="token punctuation">(</span>
        <span class="token keyword">vec4</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token operator">-</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">vec4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">float</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token keyword">vec3</span> samplePoint<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">float</span> sphereDist <span class="token operator">=</span> <span class="token function">sphereSDF</span><span class="token punctuation">(</span>samplePoint <span class="token operator">/</span> <span class="token number">1.2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.2</span><span class="token punctuation">;</span>

    <span class="token keyword">vec3</span> cubePoint <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">invert</span><span class="token punctuation">(</span><span class="token function">rotateY</span><span class="token punctuation">(</span>iGlobalTime<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>samplePoint<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>

    <span class="token keyword">float</span> cubeDist <span class="token operator">=</span> <span class="token function">cubeSDF</span><span class="token punctuation">(</span>cubePoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">intersectSDF</span><span class="token punctuation">(</span>cubeDist<span class="token punctuation">,</span> sphereDist<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="72-均匀缩放"><a class="markdownIt-Anchor" href="#72-均匀缩放"></a> 7.2 均匀缩放</h3>
<p>均匀缩放则需要采样点先除以缩放值，再把SDF结果乘上缩放值：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">float</span> dist <span class="token operator">=</span> <span class="token function">someSDF</span><span class="token punctuation">(</span>samplePoint <span class="token operator">/</span> scalingFactor<span class="token punctuation">)</span> <span class="token operator">*</span> scalingFactor<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>原因是对采样点进行整体缩放x倍后，SDF得到的结果也会被整体缩放x倍，因此需要将SDF的结果乘上x来补偿这个差异。如果不对这个SDF的结果进行补偿，则可能会影响Ray Marching步进算法中的Sphere Tracing算法的步进距离估算，导致可能步进距离过长没有渲染出来图像</p>
<p>例如半径为1的球体的SDF是：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mo stretchy="false">)</mo><mo>=</mo><msqrt><mrow><msup><mi>x</mi><mn>2</mn></msup><mo>+</mo><msup><mi>y</mi><mn>2</mn></msup><mo>+</mo><msup><mi>z</mi><mn>2</mn></msup></mrow></msqrt><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">f(x,y,z)=\sqrt{x^2+y^2+z^2}-1
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.24em;vertical-align:-0.23329099999999992em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.006709em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"></span><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-2.9667090000000003em;"><span class="pstrut" style="height:3.2em;"></span><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg width='400em' height='1.28em' viewBox='0 0 400000 1296' preserveAspectRatio='xMinYMin slice'><path d='M263,681c0.7,0,18,39.7,52,119
c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120
c340,-704.7,510.7,-1060.3,512,-1067
l0 -0
c4.7,-7.3,11,-11,19,-11
H40000v40H1012.3
s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232
c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1
s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26
c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z
M1001 80h400000v40h-400000z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.23329099999999992em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span></span></p>
<p>假如整体缩放50%，则变成半径为0.5的球体：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>g</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mi>f</mi><mo stretchy="false">(</mo><mn>2</mn><mi>x</mi><mo separator="true">,</mo><mn>2</mn><mi>y</mi><mo separator="true">,</mo><mn>2</mn><mi>z</mi><mo stretchy="false">)</mo></mrow><mn>2</mn></mfrac><mo>=</mo><mfrac><mrow><msqrt><mrow><mn>4</mn><msup><mi>x</mi><mn>2</mn></msup><mo>+</mo><mn>4</mn><msup><mi>y</mi><mn>2</mn></msup><mo>+</mo><mn>4</mn><msup><mi>z</mi><mn>2</mn></msup></mrow></msqrt><mo>−</mo><mn>1</mn></mrow><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">g(x,y,z)=\frac{f(2x,2y,2z)}{2}=\frac{\sqrt{4x^2+4y^2+4z^2}-1}{2}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.113em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord">2</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.320834em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6348340000000001em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.6770000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9578340000000001em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"></span><span class="mord" style="padding-left:1em;"><span class="mord">4</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">4</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">4</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-2.917834em;"><span class="pstrut" style="height:3.2em;"></span><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg width='400em' height='1.28em' viewBox='0 0 400000 1296' preserveAspectRatio='xMinYMin slice'><path d='M263,681c0.7,0,18,39.7,52,119
c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120
c340,-704.7,510.7,-1060.3,512,-1067
l0 -0
c4.7,-7.3,11,-11,19,-11
H40000v40H1012.3
s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232
c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1
s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26
c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z
M1001 80h400000v40h-400000z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2821659999999999em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>并提供一个错误的未对缩放补偿的版本：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>h</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mo stretchy="false">)</mo><mo>=</mo><mi>f</mi><mo stretchy="false">(</mo><mn>2</mn><mi>x</mi><mo separator="true">,</mo><mn>2</mn><mi>y</mi><mo separator="true">,</mo><mn>2</mn><mi>z</mi><mo stretchy="false">)</mo><mo>=</mo><msqrt><mrow><mn>4</mn><msup><mi>x</mi><mn>2</mn></msup><mo>+</mo><mn>4</mn><msup><mi>y</mi><mn>2</mn></msup><mo>+</mo><mn>4</mn><msup><mi>z</mi><mn>2</mn></msup></mrow></msqrt><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">h(x,y,z)=f(2x,2y,2z)=\sqrt{4x^2+4y^2+4z^2}-1
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">h</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord">2</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.24em;vertical-align:-0.23329099999999992em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.006709em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"></span><span class="mord" style="padding-left:1em;"><span class="mord">4</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">4</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">4</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-2.9667090000000003em;"><span class="pstrut" style="height:3.2em;"></span><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg width='400em' height='1.28em' viewBox='0 0 400000 1296' preserveAspectRatio='xMinYMin slice'><path d='M263,681c0.7,0,18,39.7,52,119
c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120
c340,-704.7,510.7,-1060.3,512,-1067
l0 -0
c4.7,-7.3,11,-11,19,-11
H40000v40H1012.3
s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232
c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1
s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26
c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z
M1001 80h400000v40h-400000z'/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.23329099999999992em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span></span></p>
<p>代入SDF为0、1的点和原点试试：</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo><mo>=</mo><mn>0</mn><mspace linebreak="newline"></mspace><mi>f</mi><mo stretchy="false">(</mo><mn>2</mn><mo separator="true">,</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo><mo>=</mo><mn>1</mn><mspace linebreak="newline"></mspace><mi>f</mi><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><mn>1</mn><mspace linebreak="newline"></mspace><mspace linebreak="newline"></mspace><mi>g</mi><mo stretchy="false">(</mo><mn>0.5</mn><mo separator="true">,</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo><mo>=</mo><mn>0</mn><mspace linebreak="newline"></mspace><mi>g</mi><mo stretchy="false">(</mo><mn>1.5</mn><mo separator="true">,</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo><mo>=</mo><mn>1</mn><mspace linebreak="newline"></mspace><mi>g</mi><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><mn>0.5</mn><mspace linebreak="newline"></mspace><mspace linebreak="newline"></mspace><mi>h</mi><mo stretchy="false">(</mo><mn>0.5</mn><mo separator="true">,</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo><mo>=</mo><mn>0</mn><mspace linebreak="newline"></mspace><mi>h</mi><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo><mo>=</mo><mn>1</mn><mspace linebreak="newline"></mspace><mi>h</mi><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><mn>1</mn><mspace linebreak="newline"></mspace></mrow><annotation encoding="application/x-tex">f(1,0,0)=0\\
f(2,0,0)=1\\
f(0,0,0)=-1\\
\\
g(0.5,0,0)=0\\
g(1.5,0,0)=1\\
g(0,0,0)=-0.5\\
\\
h(0.5,0,0)=0\\
h(1,0,0)=1\\
h(0,0,0)=-1\\
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">1</span></span><span class="mspace newline"></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord">1</span><span class="mord">.</span><span class="mord">5</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span></span><span class="mspace newline"></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">h</span><span class="mopen">(</span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">h</span><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">h</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">1</span></span><span class="mspace newline"></span></span></span></span></p>
<p>可以发现函数g的SDF结果是拥有正确的距离计算的，而未补偿的函数h的SDF结果则没有正确的距离计算（例如原点与半径为0.5的球体表面距离应该是-0.5，而不是-1）</p>
<h3 id="73-非均匀缩放"><a class="markdownIt-Anchor" href="#73-非均匀缩放"></a> 7.3 非均匀缩放</h3>
<p>非均匀缩放需要避免步进距离过长导致渲染错误，因此需要这样补偿：</p>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl"><span class="token keyword">float</span> dist <span class="token operator">=</span> <span class="token function">someSDF</span><span class="token punctuation">(</span>samplePoint <span class="token operator">/</span> <span class="token keyword">vec3</span><span class="token punctuation">(</span>s_x<span class="token punctuation">,</span> s_y<span class="token punctuation">,</span> s_z<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">min</span><span class="token punctuation">(</span>s_x<span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>s_y<span class="token punctuation">,</span> s_z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="八-最终合并在一起"><a class="markdownIt-Anchor" href="#八-最终合并在一起"></a> 八、最终合并在一起</h2>
<pre class="line-numbers language-glsl" data-language="glsl"><code class="language-glsl">Shader <span class="token string">"RayMarching"</span> <span class="token punctuation">&#123;</span>
    Properties <span class="token punctuation">&#123;</span>
        <span class="token function">_MainTex</span><span class="token punctuation">(</span><span class="token string">"Texture"</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    SubShader <span class="token punctuation">&#123;</span>
        Tags <span class="token punctuation">&#123;</span>
            <span class="token string">"Queue"</span> <span class="token operator">=</span> <span class="token string">"Transparent"</span>
            <span class="token string">"RenderType"</span> <span class="token operator">=</span> <span class="token string">"Transparent"</span>
        <span class="token punctuation">&#125;</span>
        Lighting Off
        ZWrite Off
        Blend SrcAlpha OneMinusSrcAlpha

        Pass <span class="token punctuation">&#123;</span>
            CGPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"UnityCG.cginc"</span></span>

            <span class="token keyword">struct</span> <span class="token class-name">appdata</span> <span class="token punctuation">&#123;</span>
                float4 vertex <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                float2 uv <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">struct</span> <span class="token class-name">v2f</span> <span class="token punctuation">&#123;</span>
                float2 uv <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
                float4 vertex <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

            <span class="token keyword">sampler2D</span> _MainTex<span class="token punctuation">;</span>
            float4 _MainTex_ST<span class="token punctuation">;</span>

            v2f <span class="token function">vert</span><span class="token punctuation">(</span>appdata v<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                v2f o<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>vertex <span class="token operator">=</span> <span class="token function">UnityObjectToClipPos</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>uv <span class="token operator">=</span> <span class="token function">TRANSFORM_TEX</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>uv<span class="token punctuation">,</span> _MainTex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">UNITY_TRANSFER_FOG</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span>o<span class="token punctuation">.</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_MARCHING_STEPS</span> <span class="token expression"><span class="token number">255</span></span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MIN_DIST</span> <span class="token expression"><span class="token number">0</span></span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_DIST</span> <span class="token expression"><span class="token number">100</span></span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EPSILON</span> <span class="token expression"><span class="token number">0.0001</span></span></span>

            <span class="token keyword">float</span> <span class="token function">sphereSDF</span><span class="token punctuation">(</span>float3 p<span class="token punctuation">,</span> <span class="token keyword">float</span> r<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token function">length</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">-</span> r<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">float</span> <span class="token function">cubeSDF</span><span class="token punctuation">(</span>float3 p<span class="token punctuation">,</span> <span class="token keyword">float</span> w<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                float3 d <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">-</span> w<span class="token punctuation">;</span>
                <span class="token keyword">float</span> insideDistance <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>y<span class="token punctuation">,</span> d<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> outsideDistance <span class="token operator">=</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> insideDistance <span class="token operator">+</span> outsideDistance<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">float</span> <span class="token function">cylinderSDF</span><span class="token punctuation">(</span>float3 p<span class="token punctuation">,</span> <span class="token keyword">float</span> h<span class="token punctuation">,</span> <span class="token keyword">float</span> r<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              float2 d <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">float2</span><span class="token punctuation">(</span><span class="token function">length</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>xz<span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">float2</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>x<span class="token punctuation">,</span> d<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            float4x4 <span class="token function">rotate</span><span class="token punctuation">(</span><span class="token keyword">float</span> theta<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">float</span> c <span class="token operator">=</span> <span class="token function">cos</span><span class="token punctuation">(</span>theta<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> s <span class="token operator">=</span> <span class="token function">sin</span><span class="token punctuation">(</span>theta<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">mul</span><span class="token punctuation">(</span><span class="token function">float4x4</span><span class="token punctuation">(</span>
                    <span class="token function">float4</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">float4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">float4</span><span class="token punctuation">(</span><span class="token operator">-</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">float4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">float4x4</span><span class="token punctuation">(</span>
                    <span class="token function">float4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">float4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token operator">-</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">float4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">float4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">float</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span>float3 p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">float</span> t <span class="token operator">=</span> _Time<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
                p <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span><span class="token function">rotate</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> cube <span class="token operator">=</span> <span class="token function">cubeSDF</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> sphereA <span class="token operator">=</span> <span class="token function">sphereSDF</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token number">1.3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> cylinderA <span class="token operator">=</span> <span class="token function">cylinderSDF</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> cylinderB <span class="token operator">=</span> <span class="token function">cylinderSDF</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> cylinderC <span class="token operator">=</span> <span class="token function">cylinderSDF</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> dist <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>cube<span class="token punctuation">,</span> sphereA<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token function">min</span><span class="token punctuation">(</span>cylinderA<span class="token punctuation">,</span> cylinderB<span class="token punctuation">)</span><span class="token punctuation">,</span> cylinderC<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">float</span> l <span class="token operator">=</span> <span class="token number">0.8</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> r <span class="token operator">=</span> <span class="token number">0.4</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> sphereB <span class="token operator">=</span> <span class="token function">sphereSDF</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token function">float3</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> sphereC <span class="token operator">=</span> <span class="token function">sphereSDF</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token operator">-</span>l<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> sphereD <span class="token operator">=</span> <span class="token function">sphereSDF</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> l<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> sphereE <span class="token operator">=</span> <span class="token function">sphereSDF</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span>l<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> sphereF <span class="token operator">=</span> <span class="token function">sphereSDF</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> l<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> sphereG <span class="token operator">=</span> <span class="token function">sphereSDF</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span>l<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                dist <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>dist<span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token function">min</span><span class="token punctuation">(</span>sphereB<span class="token punctuation">,</span> sphereC<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>sphereD<span class="token punctuation">,</span> sphereE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>sphereF<span class="token punctuation">,</span> sphereG<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> dist<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">float</span> <span class="token function">shortestDistanceToSurface</span><span class="token punctuation">(</span>float3 eye<span class="token punctuation">,</span> float3 marchingDirection<span class="token punctuation">,</span> <span class="token keyword">float</span> start<span class="token punctuation">,</span> <span class="token keyword">float</span> end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">float</span> depth <span class="token operator">=</span> start<span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> MAX_MARCHING_STEPS<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">float</span> dist <span class="token operator">=</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span>eye <span class="token operator">+</span> depth <span class="token operator">*</span> marchingDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>dist <span class="token operator">&lt;</span> EPSILON<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">return</span> depth<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                    depth <span class="token operator">+=</span> dist<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>depth <span class="token operator">>=</span> end<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">return</span> end<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">return</span> end<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            float3 <span class="token function">rayDirection</span><span class="token punctuation">(</span><span class="token keyword">float</span> fieldOfView<span class="token punctuation">,</span> float2 size<span class="token punctuation">,</span> float2 fragCoord<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                float2 xy <span class="token operator">=</span> fragCoord <span class="token operator">-</span> size <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> z <span class="token operator">=</span> size<span class="token punctuation">.</span>y <span class="token operator">/</span> <span class="token function">tan</span><span class="token punctuation">(</span><span class="token function">radians</span><span class="token punctuation">(</span>fieldOfView<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>xy<span class="token punctuation">,</span> <span class="token operator">-</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            float3 <span class="token function">estimateNormal</span><span class="token punctuation">(</span>float3 p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>
                    <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x <span class="token operator">+</span> EPSILON<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x <span class="token operator">-</span> EPSILON<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y <span class="token operator">+</span> EPSILON<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y <span class="token operator">-</span> EPSILON<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z <span class="token operator">+</span> EPSILON<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">sceneSDF</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>z <span class="token operator">-</span> EPSILON<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            float3 <span class="token function">phongContribForLight</span><span class="token punctuation">(</span>float3 k_d<span class="token punctuation">,</span> float3 k_s<span class="token punctuation">,</span> <span class="token keyword">float</span> alpha<span class="token punctuation">,</span> float3 p<span class="token punctuation">,</span> float3 eye<span class="token punctuation">,</span> float3 lightPos<span class="token punctuation">,</span> float3 lightIntensity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                float3 N <span class="token operator">=</span> <span class="token function">estimateNormal</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 L <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>lightPos <span class="token operator">-</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 V <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>eye <span class="token operator">-</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 R <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">reflect</span><span class="token punctuation">(</span><span class="token operator">-</span>L<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">float</span> dotLN <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>L<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> dotRV <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>R<span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>dotLN <span class="token operator">&lt;</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// Light not visible from this point on the surface</span>
                    <span class="token keyword">return</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> 

                <span class="token keyword">if</span> <span class="token punctuation">(</span>dotRV <span class="token operator">&lt;</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// Light reflection in opposite direction as viewer, apply only diffuse</span>
                    <span class="token comment">// component</span>
                    <span class="token keyword">return</span> lightIntensity <span class="token operator">*</span> <span class="token punctuation">(</span>k_d <span class="token operator">*</span> dotLN<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">return</span> lightIntensity <span class="token operator">*</span> <span class="token punctuation">(</span>k_d <span class="token operator">*</span> dotLN <span class="token operator">+</span> k_s <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span>dotRV<span class="token punctuation">,</span> alpha<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            float3 <span class="token function">phongIllumination</span><span class="token punctuation">(</span>float3 k_a<span class="token punctuation">,</span> float3 k_d<span class="token punctuation">,</span> float3 k_s<span class="token punctuation">,</span> <span class="token keyword">float</span> alpha<span class="token punctuation">,</span> float3 p<span class="token punctuation">,</span> float3 eye<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">float</span> iTime <span class="token operator">=</span> _Time<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
                <span class="token keyword">const</span> float3 ambientLight <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 color <span class="token operator">=</span> ambientLight <span class="token operator">*</span> k_a<span class="token punctuation">;</span>
                float3 light1Pos <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">4.0</span> <span class="token operator">*</span> <span class="token function">sin</span><span class="token punctuation">(</span>iTime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token number">4.0</span> <span class="token operator">*</span> <span class="token function">cos</span><span class="token punctuation">(</span>iTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 light1Intensity <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                color <span class="token operator">+=</span> <span class="token function">phongContribForLight</span><span class="token punctuation">(</span>k_d<span class="token punctuation">,</span> k_s<span class="token punctuation">,</span> alpha<span class="token punctuation">,</span> p<span class="token punctuation">,</span> eye<span class="token punctuation">,</span> light1Pos<span class="token punctuation">,</span> light1Intensity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 light2Pos <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">2.0</span> <span class="token operator">*</span> <span class="token function">sin</span><span class="token punctuation">(</span><span class="token number">0.37</span> <span class="token operator">*</span> iTime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2.0</span> <span class="token operator">*</span> <span class="token function">cos</span><span class="token punctuation">(</span><span class="token number">0.37</span> <span class="token operator">*</span> iTime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 light2Intensity <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                color <span class="token operator">+=</span> <span class="token function">phongContribForLight</span><span class="token punctuation">(</span>k_d<span class="token punctuation">,</span> k_s<span class="token punctuation">,</span> alpha<span class="token punctuation">,</span> p<span class="token punctuation">,</span> eye<span class="token punctuation">,</span> light2Pos<span class="token punctuation">,</span> light2Intensity<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> color<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            float4x4 <span class="token function">viewMatrix</span><span class="token punctuation">(</span>float3 eye<span class="token punctuation">,</span> float3 center<span class="token punctuation">,</span> float3 up<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// Based on gluLookAt man page</span>
                float3 f <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>center <span class="token operator">-</span> eye<span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 s <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">cross</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> up<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 u <span class="token operator">=</span> <span class="token function">cross</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">float4x4</span><span class="token punctuation">(</span>
                    <span class="token function">float4</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">float4</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">float4</span><span class="token punctuation">(</span><span class="token operator">-</span>f<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">float4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            fixed4 <span class="token function">frag</span> <span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target <span class="token punctuation">&#123;</span>
                float3 viewDir <span class="token operator">=</span> <span class="token function">rayDirection</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 eye <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                float4x4 viewToWorld <span class="token operator">=</span> <span class="token function">viewMatrix</span><span class="token punctuation">(</span>eye<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                float3 worldDir <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span><span class="token function">float4</span><span class="token punctuation">(</span>viewDir<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> viewToWorld<span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span> <span class="token comment">// 这里需要反过来使用mul计算</span>
                <span class="token keyword">float</span> dist <span class="token operator">=</span> <span class="token function">shortestDistanceToSurface</span><span class="token punctuation">(</span>eye<span class="token punctuation">,</span> worldDir<span class="token punctuation">,</span> MIN_DIST<span class="token punctuation">,</span> MAX_DIST<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>dist <span class="token operator">></span> MAX_DIST <span class="token operator">-</span> EPSILON<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// Didn't hit anything</span>
                    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token comment">// The closest point on the surface to the eyepoint along the view ray</span>
                float3 p <span class="token operator">=</span> eye <span class="token operator">+</span> dist <span class="token operator">*</span> worldDir<span class="token punctuation">;</span>
                float3 K_a <span class="token operator">=</span> <span class="token number">0.05</span><span class="token punctuation">;</span>
                float3 K_d <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// float3(0.7, 0.2, 0.2);</span>
                float3 K_s <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> shininess <span class="token operator">=</span> <span class="token number">10.0</span><span class="token punctuation">;</span>
                float3 color <span class="token operator">=</span> <span class="token function">phongIllumination</span><span class="token punctuation">(</span>K_a<span class="token punctuation">,</span> K_d<span class="token punctuation">,</span> K_s<span class="token punctuation">,</span> shininess<span class="token punctuation">,</span> p<span class="token punctuation">,</span> eye<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">fixed4</span><span class="token punctuation">(</span>color<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            ENDCG
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="/img/ray-marching-000.png" alt="" / srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="/img/ray-marching-000.png" class="lozad post-image"></p>
<h2 id="九-进阶unity后处理绘制3d效果体积云等todo"><a class="markdownIt-Anchor" href="#九-进阶unity后处理绘制3d效果体积云等todo"></a> 九、进阶：Unity后处理绘制3D效果，体积云等（todo…）</h2>
<p>参考：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1964y157fA/">https://www.bilibili.com/video/BV1964y157fA/</a></p>
<p>todo，留到另外的文章说明</p>

  </div>
  <div>
  
  <div class="post-note note-warning copyright" style="margin-top: 42px">
    <p><span style="font-weight: bold;">作者：</span><a target="_blank" rel="nofollow noopener noreferrer" href="https://numbfish-luo.github.io/about">Numbfish</a></p>
    <p><span style="font-weight: bold;">文章链接：</span><a target="_blank" rel="nofollow noopener noreferrer" href="https://numbfish-luo.github.io/2024/08/07/ray-marching/">https://numbfish-luo.github.io/2024/08/07/ray-marching/</a></p>
    <p><span style="font-weight: bold;">版权声明：</span>本博客所有文章除特别声明外，均采用<a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0 协议</a>。转载请注明出处！</p>
  </div>
  
  </div>
</article>
<div class="nav">
  
  
  <div class="nav-item-next">
    <a href="/2024/08/06/cgj-2024/" class="nav-link">
      <div>
        <div class="nav-label">下一篇</div>
        
        <div class="nav-title">CGJ 2024 SOLO作品《无限死斗》，用数学几何运算构筑你的无限攻击力卡组 </div>
        
      </div>
      <i class="iconfont icon-right nav-next-icon"></i>
    </a>
  </div>
  
</div>

<div class="card card-content toc-card" id="mobiletoc">
  <div class="toc-header"><i class="iconfont icon-menu" style="padding-right: 2px;"></i>目录</div>
<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ray-marching"><span class="toc-text"> Ray Marching</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E7%AE%80%E4%BB%8B"><span class="toc-text"> 一、简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-signed-distance-functionssdf%E6%9C%89%E7%AC%A6%E5%8F%B7%E8%B7%9D%E7%A6%BB%E5%87%BD%E6%95%B0"><span class="toc-text"> 二、Signed Distance Functions（SDF，有符号距离函数）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-ray-marching%E5%85%89%E7%BA%BF%E6%AD%A5%E8%BF%9B"><span class="toc-text"> 三、Ray Marching（光线步进）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-%E5%B9%B3%E9%9D%A2%E6%B3%95%E7%BA%BF%E4%B8%8E%E5%85%89%E7%85%A7"><span class="toc-text"> 四、平面法线与光照</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-%E7%9B%B8%E6%9C%BA%E7%A7%BB%E5%8A%A8"><span class="toc-text"> 五、相机移动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD-%E6%9E%84%E5%BB%BA%E5%87%A0%E4%BD%95%E4%BD%93"><span class="toc-text"> 六、构建几何体</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83-%E6%A8%A1%E5%9E%8B%E5%8F%98%E6%8D%A2"><span class="toc-text"> 七、模型变换</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#71-%E4%BD%8D%E7%A7%BB%E5%92%8C%E6%97%8B%E8%BD%AC"><span class="toc-text"> 7.1 位移和旋转</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#72-%E5%9D%87%E5%8C%80%E7%BC%A9%E6%94%BE"><span class="toc-text"> 7.2 均匀缩放</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#73-%E9%9D%9E%E5%9D%87%E5%8C%80%E7%BC%A9%E6%94%BE"><span class="toc-text"> 7.3 非均匀缩放</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB-%E6%9C%80%E7%BB%88%E5%90%88%E5%B9%B6%E5%9C%A8%E4%B8%80%E8%B5%B7"><span class="toc-text"> 八、最终合并在一起</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D-%E8%BF%9B%E9%98%B6unity%E5%90%8E%E5%A4%84%E7%90%86%E7%BB%98%E5%88%B63d%E6%95%88%E6%9E%9C%E4%BD%93%E7%A7%AF%E4%BA%91%E7%AD%89todo"><span class="toc-text"> 九、进阶：Unity后处理绘制3D效果，体积云等（todo…）</span></a></li></ol></li></ol>
</div></main>
          <aside class="left-column">
            
            <div class="card card-author">
              
<img src="/img/numbfish-icon-000.jpg" class="author-img">

<p class="author-name">Numbfish</p>
<p class="author-description">程策美全能型TA</p>
<div class="author-message">
  <a class="author-posts-count" href="/archives">
    <span>19</span>
    <span>文章</span>
  </a>
  <a class="author-categories-count" href="/categories">
    <span>7</span>
    <span>分类</span>
  </a>
  <a class="author-tags-count" href="/tags">
    <span>0</span>
    <span>标签</span>
  </a>
</div>

            </div>
            
            <div class="sticky-tablet">
  
  
  <article class="display-when-two-columns spacer">
    <div class="card card-content toc-card">
      <div class="toc-header"><i class="iconfont icon-menu" style="padding-right: 2px;"></i>目录</div>
<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ray-marching"><span class="toc-text"> Ray Marching</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E7%AE%80%E4%BB%8B"><span class="toc-text"> 一、简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-signed-distance-functionssdf%E6%9C%89%E7%AC%A6%E5%8F%B7%E8%B7%9D%E7%A6%BB%E5%87%BD%E6%95%B0"><span class="toc-text"> 二、Signed Distance Functions（SDF，有符号距离函数）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-ray-marching%E5%85%89%E7%BA%BF%E6%AD%A5%E8%BF%9B"><span class="toc-text"> 三、Ray Marching（光线步进）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-%E5%B9%B3%E9%9D%A2%E6%B3%95%E7%BA%BF%E4%B8%8E%E5%85%89%E7%85%A7"><span class="toc-text"> 四、平面法线与光照</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-%E7%9B%B8%E6%9C%BA%E7%A7%BB%E5%8A%A8"><span class="toc-text"> 五、相机移动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD-%E6%9E%84%E5%BB%BA%E5%87%A0%E4%BD%95%E4%BD%93"><span class="toc-text"> 六、构建几何体</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83-%E6%A8%A1%E5%9E%8B%E5%8F%98%E6%8D%A2"><span class="toc-text"> 七、模型变换</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#71-%E4%BD%8D%E7%A7%BB%E5%92%8C%E6%97%8B%E8%BD%AC"><span class="toc-text"> 7.1 位移和旋转</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#72-%E5%9D%87%E5%8C%80%E7%BC%A9%E6%94%BE"><span class="toc-text"> 7.2 均匀缩放</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#73-%E9%9D%9E%E5%9D%87%E5%8C%80%E7%BC%A9%E6%94%BE"><span class="toc-text"> 7.3 非均匀缩放</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB-%E6%9C%80%E7%BB%88%E5%90%88%E5%B9%B6%E5%9C%A8%E4%B8%80%E8%B5%B7"><span class="toc-text"> 八、最终合并在一起</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D-%E8%BF%9B%E9%98%B6unity%E5%90%8E%E5%A4%84%E7%90%86%E7%BB%98%E5%88%B63d%E6%95%88%E6%9E%9C%E4%BD%93%E7%A7%AF%E4%BA%91%E7%AD%89todo"><span class="toc-text"> 九、进阶：Unity后处理绘制3D效果，体积云等（todo…）</span></a></li></ol></li></ol>
    </div>
  </article>
  
  
  <article class="card card-content">
    <div class="categories-card">
  <div class="categories-header"><i class="iconfont icon-fenlei" style="padding-right: 2px;"></i>分类</div>
  <div class="categories-list">
    
      <a href="/categories/编程">
        <div class="categories-list-item">
          编程
          <span class="categories-list-item-badge">2</span>
        </div>
      </a>
    
      <a href="/categories/Unity">
        <div class="categories-list-item">
          Unity
          <span class="categories-list-item-badge">4</span>
        </div>
      </a>
    
      <a href="/categories/GameJam">
        <div class="categories-list-item">
          GameJam
          <span class="categories-list-item-badge">7</span>
        </div>
      </a>
    
      <a href="/categories/Shader">
        <div class="categories-list-item">
          Shader
          <span class="categories-list-item-badge">3</span>
        </div>
      </a>
    
      <a href="/categories/数学">
        <div class="categories-list-item">
          数学
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
      <a href="/categories/网页">
        <div class="categories-list-item">
          网页
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
      <a href="/categories/杂项">
        <div class="categories-list-item">
          杂项
          <span class="categories-list-item-badge">1</span>
        </div>
      </a>
    
  </div>
</div>
  </article>
  
  <article class="card card-content">
    <div class="tags-card">
  <div class="tags-header"><i class="iconfont icon-biaoqian" style="padding-right: 2px;"></i>热门标签</div>
  <div class="tags-list">
    
  </div>
</div>
  </article>
  
  
</div>
          </aside>
          <aside class="right-column">
            <div class="sticky-widescreen">
  
  
  <article class="card card-content toc-card">
    <div class="toc-header"><i class="iconfont icon-menu" style="padding-right: 2px;"></i>目录</div>
<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ray-marching"><span class="toc-text"> Ray Marching</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E7%AE%80%E4%BB%8B"><span class="toc-text"> 一、简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-signed-distance-functionssdf%E6%9C%89%E7%AC%A6%E5%8F%B7%E8%B7%9D%E7%A6%BB%E5%87%BD%E6%95%B0"><span class="toc-text"> 二、Signed Distance Functions（SDF，有符号距离函数）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-ray-marching%E5%85%89%E7%BA%BF%E6%AD%A5%E8%BF%9B"><span class="toc-text"> 三、Ray Marching（光线步进）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-%E5%B9%B3%E9%9D%A2%E6%B3%95%E7%BA%BF%E4%B8%8E%E5%85%89%E7%85%A7"><span class="toc-text"> 四、平面法线与光照</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-%E7%9B%B8%E6%9C%BA%E7%A7%BB%E5%8A%A8"><span class="toc-text"> 五、相机移动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD-%E6%9E%84%E5%BB%BA%E5%87%A0%E4%BD%95%E4%BD%93"><span class="toc-text"> 六、构建几何体</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83-%E6%A8%A1%E5%9E%8B%E5%8F%98%E6%8D%A2"><span class="toc-text"> 七、模型变换</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#71-%E4%BD%8D%E7%A7%BB%E5%92%8C%E6%97%8B%E8%BD%AC"><span class="toc-text"> 7.1 位移和旋转</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#72-%E5%9D%87%E5%8C%80%E7%BC%A9%E6%94%BE"><span class="toc-text"> 7.2 均匀缩放</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#73-%E9%9D%9E%E5%9D%87%E5%8C%80%E7%BC%A9%E6%94%BE"><span class="toc-text"> 7.3 非均匀缩放</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB-%E6%9C%80%E7%BB%88%E5%90%88%E5%B9%B6%E5%9C%A8%E4%B8%80%E8%B5%B7"><span class="toc-text"> 八、最终合并在一起</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D-%E8%BF%9B%E9%98%B6unity%E5%90%8E%E5%A4%84%E7%90%86%E7%BB%98%E5%88%B63d%E6%95%88%E6%9E%9C%E4%BD%93%E7%A7%AF%E4%BA%91%E7%AD%89todo"><span class="toc-text"> 九、进阶：Unity后处理绘制3D效果，体积云等（todo…）</span></a></li></ol></li></ol>
  </article>
  
  
  <article class="card card-content">
    <div class="recent-posts-card">
  <div class="recent-posts-header"><i class="iconfont icon-wenzhang_huaban" style="padding-right: 2px;"></i>最近文章</div>
  <div class="recent-posts-list">
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2024-08-07</div>
        <a href="/2024/08/07/ray-marching/"><div class="recent-posts-item-content">二渲三技术，光线步进Ray Marching</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2024-08-06</div>
        <a href="/2024/08/06/cgj-2024/"><div class="recent-posts-item-content">CGJ 2024 SOLO作品《无限死斗》，用数学几何运算构筑你的无限攻击力卡组</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2024-08-04</div>
        <a href="/2024/08/04/how-to-create-a-blog-with-hexo/"><div class="recent-posts-item-content">如何用hexo创建个人博客</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2024-02-06</div>
        <a href="/2024/02/06/math-fire/"><div class="recent-posts-item-content">用数学做一个火焰特效</div></a>
      </div>
    
  </div>
</div>
  </article>
  
  
</div>
          </aside>
        </div>
      </div>
    </div>
  </div>
  
  <footer class="footer">
  <div class="footer-container">
    <div>
      <div class="footer-dsc">
        <span>Copyright ©
          
          2020 -
          
          2024
        </span>
        <a href="/" class="footer-link">Numbfish的个人博客 </a>
      </div>
    </div>

    
    <div class="footer-dsc">
      
      
      Powered by
      <a href="https://hexo.io/" class="footer-link" target="_blank" rel="nofollow noopener noreferrer">&nbsp;Hexo </a>
      
      
      <span>&nbsp;|&nbsp;</span>
      
      
      
      Theme -
      <a href="https://github.com/theme-kaze" class="footer-link" target="_blank"
        rel="nofollow noopener noreferrer">&nbsp;Kaze</a>
      
    </div>
    
    
    
    
</footer>
  <a role="button" id="scrollbutton" class="basebutton" >
  <i class="iconfont icon-arrowleft button-icon"></i>
</a>
<a role="button" id="menubutton" class="basebutton">
  <i class="iconfont icon-menu button-icon"></i>
</a>
<a role="button" id="popbutton" class="basebutton">
  <i class="iconfont icon-expand button-icon"></i>
</a>
<a role="button" id="darkbutton" class="basebutton darkwidget">
  <i class="iconfont icon-weather button-icon"></i>
</a>

  
  
  

  
  
    
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css">

  

  
  
  <script>
  var addImgLayout = function () {
    var img = document.querySelectorAll('.post-content img');
    var i;
    for (i = 0; i < img.length; i++) {
      var wrapper = document.createElement('a');
      wrapper.setAttribute('data-fslightbox', 'gallery');
      wrapper.setAttribute('href', img[i].getAttribute('data-src'));
      wrapper.setAttribute('style', 'width: 100%; display: flex; justify-content: center;');
      img[i].parentElement.insertBefore(wrapper, img[i]);
      wrapper.appendChild(img[i]);
    }
    refreshFsLightbox();
  }
</script>
<script>loadScript("//cdn.jsdelivr.net/npm/fslightbox@3.1.0/index.min.js", addImgLayout)</script>
  
  
  
<script src="/js/main.js"></script>

  
  
  <script>
    var addLazyload = function () {
      var observer = lozad('.lozad', {
        load: function (el) {
          el.srcset = el.getAttribute('data-src');
        },
        loaded: function (el) {
          el.classList.add('loaded');
        }
      });
      observer.observe();
    }
  </script>
  <script>loadScript("/js/lib/lozad.min.js", addLazyload)</script>
  
  
</body>

</html>